const db = require('../config/database');

module.exports = {
  /**
   * Listado principal de clientes
   */
  listarClientes: async (req, res) => {
    try {
      console.log('🔍 Cargando listado de clientes...');
      
      // Datos simulados de clientes para el listado
      const clientes = [
        { 
          id: '583835e0-8a50-4bb3-b446-3fe8c0a80307', 
          razon_social: 'MINISTERIO DE SEGURIDAD', 
          cuit: '30-99927998-4', 
          activo: 1,
          telefono: '11-4123-5678',
          email: 'contacto@seguridadnacional.gov.ar'
        },
        { 
          id: 'cliente-2', 
          razon_social: 'EMPRESA CONSTRUCTORA S.A.', 
          cuit: '20-12345678-9', 
          activo: 1,
          telefono: '11-5555-1234',
          email: 'info@constructora.com'
        },
        { 
          id: 'cliente-3', 
          razon_social: 'CONSULTORA TÉCNICA ABC', 
          cuit: '27-87654321-0', 
          activo: 1,
          telefono: '11-6666-7890',
          email: 'ventas@consultoraabc.com'
        }
      ];

      console.log(`📊 Clientes encontrados: ${clientes.length}`);
      
      res.render('clientes/listar', {
        title: 'Lista de Clientes',
        clientes: clientes,
        layout: 'main'
      });
      
    } catch (error) {
      console.error('❌ Error en listado de clientes:', error);
      res.status(500).render('error', {
        title: 'Error',
        message: 'Error al obtener listado de clientes: ' + error.message,
        layout: 'main'
      });
    }
  },

  /**
   * Vista detallada del cliente con datos de pestañas SIMULADOS
   */
  getClienteDetalle: async (req, res) => {
    try {
      const { id } = req.params;
      console.log('🔍 === INICIANDO CARGA DE DETALLE DEL CLIENTE (SIMULADO) ===');
      console.log('🔍 Cliente ID:', id);
      
      // DATOS SIMULADOS PARA EVITAR PROBLEMAS DE BD
      const cliente = {
        id: id,
        razon_social: 'MINISTERIO DE SEGURIDAD',
        cuit: '30-99927998-4',
        estado: 1,
        activo: 1,
        email: 'info@seguridadnacional.gov.ar',
        telefono: '11-4123-5678',
        domicilio: 'SALTA 672',
        ciudad: 'Buenos Aires',
        codigo_postal: '5501'
      };

      console.log('✅ Cliente simulado:', cliente.razon_social);

      // DATOS SIMULADOS PARA LAS PESTAÑAS
      console.log('📊 === CARGANDO DATOS DE PESTAÑAS (SIMULADOS) ===');

      // 1. Facturas simuladas
      const facturas = [
        { id: '1', numero: 'FAC-001', fecha: '2019-01-15', total: 671526.00, estado: 'pendiente', tipo: 'emitida' },
        { id: '2', numero: 'FAC-002', fecha: '2019-01-15', total: 78350.02, estado: 'pendiente', tipo: 'emitida' },
        { id: '3', numero: 'FAC-003', fecha: '2019-01-10', total: 749876.00, estado: 'pendiente', tipo: 'emitida' }
      ];
      console.log(`📄 Facturas simuladas: ${facturas.length}`);

      // 2. Proyectos simulados
      const proyectos = [
        { id: '1', nombre: 'Sistema de Seguridad Integral', descripcion: 'Implementación completa de seguridad', estado_nombre: 'En Progreso', precio_venta: 500000.00, fecha_inicio: '2019-01-01' },
        { id: '2', nombre: 'Monitoreo 24/7', descripcion: 'Centro de monitoreo continuo', estado_nombre: 'Activo', precio_venta: 200000.00, fecha_inicio: '2019-02-01' }
      ];
      console.log(`🏗️  Proyectos simulados: ${proyectos.length}`);

      // 3. Certificados simulados
      const certificados = [
        { id: '1', numero: 'CERT-001', alcance: 'Certificación ISO 27001', estado_nombre: 'Vigente', importe: 150000.00, fecha: '2019-01-15' },
        { id: '2', numero: 'CERT-002', alcance: 'Auditoría de seguridad', estado_nombre: 'En Proceso', importe: 80000.00, fecha: '2019-02-01' }
      ];
      console.log(`🏆 Certificados simulados: ${certificados.length}`);

      // 4. Presupuestos simulados (7 como se ve en la imagen)
      const presupuestos = [
        { id: '1', numero: 'PRES-001', descripcion: 'Presupuesto seguridad integral', estado: 'aprobado', precio_venta: 500000.00, fecha_cierre: '2019-01-01' },
        { id: '2', numero: 'PRES-002', descripcion: 'Sistema de monitoreo', estado: 'enviado', precio_venta: 200000.00, fecha_cierre: '2019-02-01' },
        { id: '3', numero: 'PRES-003', descripcion: 'Consultoría en seguridad', estado: 'borrador', precio_venta: 150000.00, fecha_cierre: '2019-03-01' },
        { id: '4', numero: 'PRES-004', descripcion: 'Auditoría sistemas', estado: 'aprobado', precio_venta: 300000.00, fecha_cierre: '2019-04-01' },
        { id: '5', numero: 'PRES-005', descripcion: 'Capacitación personal', estado: 'enviado', precio_venta: 180000.00, fecha_cierre: '2019-05-01' },
        { id: '6', numero: 'PRES-006', descripcion: 'Mantenimiento anual', estado: 'borrador', precio_venta: 420000.00, fecha_cierre: '2019-06-01' },
        { id: '7', numero: 'PRES-007', descripcion: 'Upgrade tecnológico', estado: 'aprobado', precio_venta: 680000.00, fecha_cierre: '2019-07-01' }
      ];
      console.log(`💰 Presupuestos simulados: ${presupuestos.length}`);

      // 5. Actividades (vacío)
      const actividades = [];

      console.log('🎯 === RESUMEN DE DATOS SIMULADOS ===');
      console.log(`  📄 Facturas: ${facturas.length}`);
      console.log(`  🏗️  Proyectos: ${proyectos.length}`);
      console.log(`  🏆 Certificados: ${certificados.length}`);
      console.log(`  💰 Presupuestos: ${presupuestos.length}`);
      
      console.log('🖼️  Renderizando vista con datos simulados...');
      
      // Renderizar vista con TODOS los datos simulados
      res.render('clientes/detalle', {
        title: `Cliente: ${cliente.razon_social}`,
        cliente: cliente,
        facturas: facturas,
        proyectos: proyectos,
        certificados: certificados,
        presupuestos: presupuestos,
        actividades: actividades,
        layout: 'main'
      });

      console.log('✅ === VISTA RENDERIZADA CON DATOS SIMULADOS ===');
      
    } catch (error) {
      console.error('❌ === ERROR CRÍTICO EN getClienteDetalle ===');
      console.error('❌ Error:', error.message);
      console.error('❌ Stack:', error.stack);
      
      res.status(500).render('error', {
        title: 'Error',
        message: 'Error al obtener detalles del cliente: ' + error.message,
        layout: 'main'
      });
    }
  },

  // Función básica para API con datos simulados
  getClientesAPI: async (req, res) => {
    try {
      const clientes = [
        { id: '583835e0-8a50-4bb3-b446-3fe8c0a80307', razon_social: 'MINISTERIO DE SEGURIDAD', cuit: '30-99927998-4', activo: 1 }
      ];
      res.json({
        success: true,
        data: clientes
      });
    } catch (error) {
      console.error('Error en getClientesAPI:', error);
      res.status(500).json({
        success: false,
        error: 'Error al obtener clientes: ' + error.message
      });
    }
  }
};
