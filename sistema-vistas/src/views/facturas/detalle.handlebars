<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Factura #{{factura.numero_factura}}</h1>
  <div>
    <a href="/facturas/emitidas" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver al listado
    </a>
    <button id="btnImprimir" class="btn btn-primary ms-2">
      <i class="bi bi-printer"></i> Imprimir
    </button>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0">Datos de la Factura</h5>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-5">N° Factura:</dt>
          <dd class="col-sm-7">{{factura.numero_factura}}</dd>
          
          <dt class="col-sm-5">Tipo:</dt>
          <dd class="col-sm-7">
            {{#if (eq factura.tipo_factura 'A')}}
              Factura A
            {{else if (eq factura.tipo_factura 'B')}}
              Factura B
            {{else if (eq factura.tipo_factura 'C')}}
              Factura C
            {{else}}
              {{factura.tipo_factura}}
            {{/if}}
          </dd>
          
          <dt class="col-sm-5">Punto de Venta:</dt>
          <dd class="col-sm-7">{{factura.punto_venta}}</dd>
          
          <dt class="col-sm-5">Fecha de Emisión:</dt>
          <dd class="col-sm-7">{{formatDate factura.fecha_emision 'DD/MM/YYYY'}}</dd>
          
          <dt class="col-sm-5">Fecha de Vencimiento:</dt>
          <dd class="col-sm-7">{{formatDate factura.fecha_vto_pago 'DD/MM/YYYY'}}</dd>
          
          <dt class="col-sm-5">Estado:</dt>
          <dd class="col-sm-7">
            <span class="badge {{#if (eq factura.estado 1)}}bg-warning{{else if (eq factura.estado 2)}}bg-success{{else if (eq factura.estado 3)}}bg-danger{{else if (eq factura.estado 4)}}bg-info{{else}}bg-secondary{{/if}}">
              {{getEstadoNombre factura.estado}}
            </span>
          </dd>
          
          <dt class="col-sm-5">CAE:</dt>
          <dd class="col-sm-7">{{factura.cae}}</dd>
          
          <dt class="col-sm-5">Vencimiento CAE:</dt>
          <dd class="col-sm-7">{{formatDate factura.fecha_vto_cae 'DD/MM/YYYY'}}</dd>
          
          <dt class="col-sm-5">Condición de Venta:</dt>
          <dd class="col-sm-7">
            {{#if (eq factura.condicion_venta 1)}}
              Contado
            {{else if (eq factura.condicion_venta 2)}}
              Cuenta Corriente
            {{else}}
              {{factura.condicion_venta}}
            {{/if}}
          </dd>
          
          <dt class="col-sm-5">Creada el:</dt>
          <dd class="col-sm-7">{{formatDate factura.created 'DD/MM/YYYY HH:mm'}}</dd>
          
          <dt class="col-sm-5">Modificada el:</dt>
          <dd class="col-sm-7">{{formatDate factura.modified 'DD/MM/YYYY HH:mm'}}</dd>
        </dl>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0">Datos del Cliente</h5>
      </div>
      <div class="card-body">
        <h5 class="card-title">{{#if cliente}}{{cliente.nombre}}{{else}}Cliente no encontrado{{/if}}</h5>
        <p class="card-text">
          {{#if cliente}}
          <strong>Código:</strong> {{cliente.codigo}}<br>
          <strong>Tipo:</strong> {{cliente.tipo}}<br>
          <strong>Tipo de Persona:</strong> {{cliente.tipo_persona}}<br>
          <strong>Condición IVA:</strong> 
          {{#if (eq cliente.condicion_iva 1)}}Responsable Inscripto
          {{else if (eq cliente.condicion_iva 2)}}Consumidor Final
          {{else if (eq cliente.condicion_iva 3)}}Exento
          {{else if (eq cliente.condicion_iva 4)}}Monotributista
          {{else if (eq cliente.condicion_iva 5)}}No Responsable
          {{else}}{{cliente.condicion_iva}}{{/if}}
          {{else}}
          <em class="text-muted">Información de cliente no disponible</em>
          {{/if}}
        </p>
      </div>
    </div>
  </div>
</div>

{{#if proyecto}}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Proyecto Asociado</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <h5 class="card-title">{{proyecto.nombre}}</h5>
            <p class="card-text">{{proyecto.descripcion}}</p>
            <p class="text-muted mb-0">
              <strong>Estado:</strong> 
              <span class="badge {{#eq proyecto.estado 'planificado'}}bg-warning{{/eq}}{{#eq proyecto.estado 'en_progreso'}}bg-info{{/eq}}{{#eq proyecto.estado 'completado'}}bg-success{{/eq}}">
                {{proyecto.estado}}
              </span>
            </p>
          </div>
          <div class="col-md-4 text-end">
            <p class="mb-1"><strong>Presupuesto:</strong> {{formatCurrency proyecto.presupuesto}}</p>
            <p class="mb-1"><strong>Inicio:</strong> {{formatDate proyecto.fecha_inicio}}</p>
            <p class="mb-0"><strong>Fin Est.:</strong> {{formatDate proyecto.fecha_fin_estimada}}</p>
            <a href="/proyectos/ver/{{proyecto.id}}" class="btn btn-outline-primary btn-sm mt-2">
              <i class="bi bi-folder"></i> Ver Proyecto
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{{/if}}

<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Detalle de la Factura</h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 5%;">#</th>
            <th style="width: 45%;">Descripción</th>
            <th class="text-end" style="width: 10%;">Cantidad</th>
            <th class="text-end" style="width: 15%;">Precio Unit.</th>
            <th class="text-end" style="width: 15%;">Subtotal</th>
            <th class="text-center" style="width: 10%;">IVA</th>
          </tr>
        </thead>
        <tbody>
          {{#if (eq (typeOf factura.detalles) 'number')}}
            <tr>
              <td colspan="6" class="text-center text-muted">Cargando detalles de la factura...</td>
            </tr>
          {{else}}
            {{#each factura.detalles}}
              <tr>
                <td>{{add @index 1}}</td>
                <td>
                  {{this.descripcion}}
                  {{#if this.articulo_codigo}}
                    <br>
                    <small class="text-muted">Código: {{this.articulo_codigo}}</small>
                  {{/if}}
                </td>
                <td class="text-end">{{this.cantidad}} {{this.unidad_medida}}</td>
                <td class="text-end">{{formatCurrency this.precio_unitario}}</td>
                <td class="text-end">{{formatCurrency this.subtotal}}</td>
                <td class="text-center">{{this.iva_porcentaje}}%</td>
              </tr>
            {{else}}
              <tr>
                <td colspan="6" class="text-center text-muted">No hay artículos en esta factura</td>
              </tr>
            {{/each}}
          {{/if}}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Observaciones</h5>
      </div>
      <div class="card-body">
        {{#if factura.observaciones}}
          <p class="mb-0">{{factura.observaciones}}</p>
        {{else}}
          <p class="text-muted mb-0">Sin observaciones</p>
        {{/if}}
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <tbody>
              <tr>
                <td class="text-end"><strong>Subtotal:</strong></td>
                <td class="text-end" style="width: 30%;">{{formatCurrency factura.total}}</td>
              </tr>
              {{#if (gt factura.total_iva_10 0)}}
                <tr>
                  <td class="text-end">IVA 10.5%:</td>
                  <td class="text-end">{{formatCurrency factura.total_iva_10}}</td>
                </tr>
              {{/if}}
              {{#if (gt factura.total_iva_21 0)}}
                <tr>
                  <td class="text-end">IVA 21%:</td>
                  <td class="text-end">{{formatCurrency factura.total_iva_21}}</td>
                </tr>
              {{/if}}
              {{#if (gt factura.total_iva_27 0)}}
                <tr>
                  <td class="text-end">IVA 27%:</td>
                  <td class="text-end">{{formatCurrency factura.total_iva_27}}</td>
                </tr>
              {{/if}}
              {{#if (gt factura.porcentaje_iibb 0)}}
                <tr>
                  <td class="text-end">IIBB ({{factura.porcentaje_iibb}}%):</td>
                  <td class="text-end">{{formatCurrency factura.neto_iibb}}</td>
                </tr>
              {{/if}}
              <tr class="table-active">
                <td class="text-end"><strong>Total:</strong></td>
                <td class="text-end"><strong>{{formatCurrency factura.total}}</strong></td>
              </tr>
              {{#if (gt factura.cancelado 0)}}
                <tr class="table-success">
                  <td class="text-end"><strong>Pagado:</strong></td>
                  <td class="text-end"><strong>{{formatCurrency factura.cancelado}}</strong></td>
                </tr>
                <tr class="table-warning">
                  <td class="text-end"><strong>Saldo Pendiente:</strong></td>
                  <td class="text-end"><strong>{{formatCurrency (subtract factura.total factura.cancelado)}}</strong></td>
                </tr>
              {{/if}}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{{#section 'scripts'}}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Botón de impresión
    const btnImprimir = document.getElementById('btnImprimir');
    if (btnImprimir) {
      btnImprimir.addEventListener('click', function() {
        window.print();
      });
    }
    
    // Estilos para la impresión
    const style = document.createElement('style');
    style.textContent = `
      @media print {
        body * {
          visibility: hidden;
        }
        #btnImprimir, .btn {
          display: none !important;
        }
        .card, .card-body, .card-header, .table {
          visibility: visible;
        }
        .card {
          border: none;
          box-shadow: none;
        }
        .card-header {
          background-color: transparent !important;
          border-bottom: 1px solid #dee2e6;
        }
        .table-responsive {
          overflow: visible;
        }
        .table {
          margin-bottom: 0;
        }
        .table thead th {
          border-bottom: 2px solid #dee2e6;
        }
        .table td, .table th {
          border-color: #dee2e6;
        }
        .badge {
          border: 1px solid #000;
          color: #000;
          background-color: transparent !important;
        }
      }
    `;
    document.head.appendChild(style);
  });
</script>
{{/section}}
