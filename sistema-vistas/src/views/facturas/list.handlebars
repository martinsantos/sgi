{{> header title="Listado de Facturas" section="facturas"}}

<div class="container-fluid">
  <!-- Filtros y búsqueda rápida -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-filter me-2"></i>Filtros y Búsqueda
      </h5>
      <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
          <i class="fas fa-times me-1"></i>Limpiar
        </button>
        <button type="button" class="btn btn-outline-primary btn-sm" id="toggleAdvanced">
          <i class="fas fa-search-plus me-1"></i>Búsqueda Avanzada
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Filtros básicos -->
      <form id="filterForm" method="GET" action="/facturas/list">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Buscar</label>
            <input type="text" class="form-control" name="search" placeholder="Número, cliente..." value="{{filters.search}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Estado</label>
            <select class="form-select" name="estado">
              <option value="">Todos</option>
              <option value="borrador" {{#eq filters.estado "borrador"}}selected{{/eq}}>Borrador</option>
              <option value="pendiente" {{#eq filters.estado "pendiente"}}selected{{/eq}}>Pendiente</option>
              <option value="pagada" {{#eq filters.estado "pagada"}}selected{{/eq}}>Pagada</option>
              <option value="vencida" {{#eq filters.estado "vencida"}}selected{{/eq}}>Vencida</option>
              <option value="anulada" {{#eq filters.estado "anulada"}}selected{{/eq}}>Anulada</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Fecha Desde</label>
            <input type="date" class="form-control" name="fecha_desde" value="{{filters.fecha_desde}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Fecha Hasta</label>
            <input type="date" class="form-control" name="fecha_hasta" value="{{filters.fecha_hasta}}">
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-1"></i>Buscar
              </button>
              <button type="button" class="btn btn-success" id="exportExcel">
                <i class="fas fa-file-excel me-1"></i>Excel
              </button>
            </div>
          </div>
        </div>

        <!-- Filtros avanzados (colapsables) -->
        <div class="row g-3 mt-3 collapse" id="advancedFilters">
          <div class="col-md-2">
            <label class="form-label">Tipo Factura</label>
            <select class="form-select" name="tipo_factura">
              <option value="">Todos</option>
              <option value="A" {{#eq filters.tipo_factura "A"}}selected{{/eq}}>A</option>
              <option value="B" {{#eq filters.tipo_factura "B"}}selected{{/eq}}>B</option>
              <option value="C" {{#eq filters.tipo_factura "C"}}selected{{/eq}}>C</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Punto Venta</label>
            <input type="number" class="form-control" name="punto_venta" placeholder="Ej: 1" value="{{filters.punto_venta}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Monto Desde</label>
            <input type="number" class="form-control" name="monto_desde" placeholder="0.00" step="0.01" value="{{filters.monto_desde}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Monto Hasta</label>
            <input type="number" class="form-control" name="monto_hasta" placeholder="0.00" step="0.01" value="{{filters.monto_hasta}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Cliente</label>
            <select class="form-select" name="cliente_id">
              <option value="">Todos los clientes</option>
              {{#each clientes}}
              <option value="{{id}}" {{#eq ../filters.cliente_id id}}selected{{/eq}}>{{nombre}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Proyecto</label>
            <select class="form-select" name="proyecto_id">
              <option value="">Todos los proyectos</option>
              {{#each proyectos}}
              <option value="{{id}}" {{#eq ../filters.proyecto_id id}}selected{{/eq}}>{{nombre}}</option>
              {{/each}}
            </select>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Resultados y acciones -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">
          <i class="fas fa-receipt me-2"></i>Facturas
          <span class="badge bg-primary ms-2">{{pagination.total}} resultados</span>
        </h5>
        {{#if filters.isFiltered}}
        <small class="text-muted">Mostrando resultados filtrados</small>
        {{/if}}
      </div>
      
      <div class="btn-group">
        <div class="btn-group me-2">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-sort me-1"></i>Ordenar por
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="?{{serialize (merge filters {sort: 'numero_factura', order: 'desc'})}}">
              Número (desc)</a></li>
            <li><a class="dropdown-item" href="?{{serialize (merge filters {sort: 'fecha_factura', order: 'desc'})}}">
              Fecha (desc)</a></li>
            <li><a class="dropdown-item" href="?{{serialize (merge filters {sort: 'total', order: 'desc'})}}">
              Monto (desc)</a></li>
            <li><a class="dropdown-item" href="?{{serialize (merge filters {sort: 'cliente', order: 'asc'})}}">
              Cliente (A-Z)</a></li>
          </ul>
        </div>
        
        <div class="btn-group me-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="viewTable" {{#eq view 'table'}}disabled{{/eq}}>
            <i class="fas fa-table"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="viewGrid" {{#eq view 'grid'}}disabled{{/eq}}>
            <i class="fas fa-th"></i>
          </button>
        </div>

        <a href="/facturas/nueva" class="btn btn-primary btn-sm">
          <i class="fas fa-plus me-1"></i>Nueva Factura
        </a>
      </div>
    </div>

    <div class="card-body p-0">
      {{#if facturas}}
        {{#eq view 'table'}}
          {{> facturas/partials/table-view}}
        {{else}}
          {{> facturas/partials/grid-view}}
        {{/eq}}
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
          <h4 class="text-muted mt-3">No se encontraron facturas</h4>
          <p class="text-muted">Intenta ajustar los filtros de búsqueda o crear una nueva factura.</p>
          <a href="/facturas/nueva" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Crear Primera Factura
          </a>
        </div>
      {{/if}}
    </div>

    {{#if facturas}}
    <div class="card-footer">
      {{> shared/pagination pagination=pagination baseUrl="/facturas/list" queryParams=filters}}
    </div>
    {{/if}}
  </div>
</div>

<!-- Modal para acciones masivas -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Acciones Masivas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¿Qué acción deseas realizar con las <span id="selectedCount">0</span> facturas seleccionadas?</p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-success" id="bulkMarkPaid">
            <i class="fas fa-check me-2"></i>Marcar como Pagadas
          </button>
          <button type="button" class="btn btn-warning" id="bulkMarkPending">
            <i class="fas fa-clock me-2"></i>Marcar como Pendientes
          </button>
          <button type="button" class="btn btn-danger" id="bulkCancel">
            <i class="fas fa-ban me-2"></i>Anular Facturas
          </button>
          <button type="button" class="btn btn-info" id="bulkExport">
            <i class="fas fa-download me-2"></i>Exportar Seleccionadas
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle filtros avanzados
  document.getElementById('toggleAdvanced').addEventListener('click', function() {
    const advancedFilters = document.getElementById('advancedFilters');
    const bsCollapse = new bootstrap.Collapse(advancedFilters);
    bsCollapse.toggle();
  });

  // Limpiar filtros
  document.getElementById('clearFilters').addEventListener('click', function() {
    window.location.href = '/facturas/list';
  });

  // Cambio de vista
  document.getElementById('viewTable')?.addEventListener('click', function() {
    updateView('table');
  });

  document.getElementById('viewGrid')?.addEventListener('click', function() {
    updateView('grid');
  });

  // Exportación
  document.getElementById('exportExcel').addEventListener('click', function() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    window.location.href = `/facturas/export/excel?${params.toString()}`;
  });

  // Selección masiva
  let selectedInvoices = new Set();

  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('invoice-select')) {
      if (e.target.checked) {
        selectedInvoices.add(e.target.value);
      } else {
        selectedInvoices.delete(e.target.value);
      }
      updateBulkActionsButton();
    }
  });

  // Seleccionar todos
  document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.invoice-select');
    checkboxes.forEach(checkbox => {
      checkbox.checked = this.checked;
      if (this.checked) {
        selectedInvoices.add(checkbox.value);
      } else {
        selectedInvoices.delete(checkbox.value);
      }
    });
    updateBulkActionsButton();
  });

  function updateBulkActionsButton() {
    const bulkButton = document.getElementById('bulkActions');
    const countSpan = document.getElementById('selectedCount');
    
    if (bulkButton && countSpan) {
      bulkButton.style.display = selectedInvoices.size > 0 ? 'inline-block' : 'none';
      countSpan.textContent = selectedInvoices.size;
    }
  }

  function updateView(viewType) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('view', viewType);
    window.location.href = currentUrl.toString();
  }

  // Auto-submit del formulario con delay
  let searchTimeout;
  const searchInput = document.querySelector('input[name="search"]');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        document.getElementById('filterForm').submit();
      }, 500);
    });
  }
});
</script>

{{> footer}}
