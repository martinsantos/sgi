<div class="table-responsive">
  <table class="table table-hover">
    <thead class="table-light">
      <tr>
        <th width="40">
          <input type="checkbox" class="form-check-input" id="selectAll">
        </th>
        <th width="100">Número</th>
        <th>Cliente</th>
        <th width="100">Fecha</th>
        <th width="100">Vencimiento</th>
        <th width="120" class="text-end">Monto</th>
        <th width="100" class="text-center">Estado</th>
        <th width="120" class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {{#each facturas}}
      <tr class="{{#isOverdue fecha_vencimiento}}table-warning{{/isOverdue}} {{#eq estado 'anulada'}}table-danger{{/eq}}">
        <td>
          <input type="checkbox" class="form-check-input invoice-select" value="{{id}}">
        </td>
        <td>
          <div class="d-flex align-items-center">
            <span class="badge bg-secondary me-2">{{tipo_factura}}</span>
            <strong>{{formatNumber punto_venta 4}}-{{formatNumber numero_factura 8}}</strong>
          </div>
        </td>
        <td>
          <div>
            <strong>{{cliente.nombre}}</strong>
            {{#if cliente.cuit}}
            <br><small class="text-muted">CUIT: {{cliente.cuit}}</small>
            {{/if}}
          </div>
        </td>
        <td>
          <span class="text-nowrap">{{formatDate fecha_factura}}</span>
        </td>
        <td>
          <span class="text-nowrap {{#isOverdue fecha_vencimiento}}text-danger{{/isOverdue}}">
            {{formatDate fecha_vencimiento}}
            {{#isOverdue fecha_vencimiento}}
            <br><small class="text-danger">
              <i class="fas fa-exclamation-triangle"></i>
              Vencida ({{daysBetween fecha_vencimiento now}} días)
            </small>
            {{/isOverdue}}
          </span>
        </td>
        <td class="text-end">
          <strong>{{formatCurrency total}}</strong>
          {{#if subtotal}}
          <br><small class="text-muted">
            Sin IVA: {{formatCurrency subtotal}}
          </small>
          {{/if}}
        </td>
        <td class="text-center">
          <span class="badge {{getStatusBadge estado}}">
            {{getStatusName estado}}
          </span>
          {{#if proyecto}}
          <br><small class="text-muted">
            <i class="fas fa-project-diagram me-1"></i>
            {{truncateText proyecto.nombre 20}}
          </small>
          {{/if}}
        </td>
        <td class="text-center">
          <div class="btn-group btn-group-sm">
            <a href="/facturas/{{id}}" class="btn btn-outline-primary" title="Ver Detalle">
              <i class="fas fa-eye"></i>
            </a>
            {{#ne estado 'pagada'}}
            <a href="/facturas/{{id}}/editar" class="btn btn-outline-warning" title="Editar">
              <i class="fas fa-edit"></i>
            </a>
            {{/ne}}
            {{#if proyecto}}
            <a href="/proyectos/{{proyecto.id}}" class="btn btn-outline-info" title="Ver Proyecto">
              <i class="fas fa-project-diagram"></i>
            </a>
            {{/if}}
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="/facturas/{{id}}/pdf" target="_blank">
                  <i class="fas fa-file-pdf me-2"></i>Descargar PDF
                </a>
              </li>
              {{#ne estado 'pagada'}}
              <li>
                <button class="dropdown-item text-success mark-paid" data-id="{{id}}">
                  <i class="fas fa-check me-2"></i>Marcar como Pagada
                </button>
              </li>
              {{/ne}}
              {{#eq estado 'borrador'}}
              <li>
                <button class="dropdown-item text-primary authorize-invoice" data-id="{{id}}">
                  <i class="fas fa-paper-plane me-2"></i>Autorizar
                </button>
              </li>
              {{/eq}}
              <li>
                <a class="dropdown-item" href="/facturas/{{id}}/duplicar">
                  <i class="fas fa-copy me-2"></i>Duplicar
                </a>
              </li>
              {{#ne estado 'anulada'}}
              <li><hr class="dropdown-divider"></li>
              <li>
                <button class="dropdown-item text-danger cancel-invoice" data-id="{{id}}">
                  <i class="fas fa-ban me-2"></i>Anular Factura
                </button>
              </li>
              {{/ne}}
            </ul>
          </div>
        </td>
      </tr>
      {{/each}}
    </tbody>
  </table>
</div>

{{#if (gt (length facturas) 0)}}
<div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
  <div>
    <button type="button" class="btn btn-outline-primary btn-sm" id="bulkActions" style="display: none;" data-bs-toggle="modal" data-bs-target="#bulkActionsModal">
      <i class="fas fa-tasks me-1"></i>
      Acciones masivas (<span id="selectedCount">0</span>)
    </button>
  </div>
  
  <div class="text-muted">
    <small>
      Mostrando {{add pagination.offset 1}} a {{add pagination.offset (length facturas)}} de {{pagination.total}} facturas
    </small>
  </div>
</div>
{{/if}}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Marcar como pagada
  document.addEventListener('click', function(e) {
    if (e.target.closest('.mark-paid')) {
      const button = e.target.closest('.mark-paid');
      const facturaId = button.getAttribute('data-id');
      
      if (confirm('¿Confirma que desea marcar esta factura como pagada?')) {
        fetch(`/facturas/${facturaId}/marcar-pagada`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error al actualizar la factura: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al procesar la solicitud');
        });
      }
    }
  });

  // Autorizar factura
  document.addEventListener('click', function(e) {
    if (e.target.closest('.authorize-invoice')) {
      const button = e.target.closest('.authorize-invoice');
      const facturaId = button.getAttribute('data-id');
      
      if (confirm('¿Confirma que desea autorizar esta factura?')) {
        fetch(`/facturas/${facturaId}/autorizar`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error al autorizar la factura: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al procesar la solicitud');
        });
      }
    }
  });

  // Anular factura
  document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-invoice')) {
      const button = e.target.closest('.cancel-invoice');
      const facturaId = button.getAttribute('data-id');
      
      if (confirm('¿Está seguro que desea ANULAR esta factura? Esta acción no se puede deshacer.')) {
        const motivo = prompt('Ingrese el motivo de la anulación:');
        if (motivo) {
          fetch(`/facturas/${facturaId}/anular`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ motivo: motivo })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error al anular la factura: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
          });
        }
      }
    }
  });
});
</script>
