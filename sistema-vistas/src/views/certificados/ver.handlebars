<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Certificado N° {{certificado.numero}}</h1>
  <div>
    <a href="{{returnUrl}}" class="btn btn-outline-secondary me-2">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
    <a href="/certificados/editar/{{certificado.id}}?return={{returnUrl}}" class="btn btn-warning me-2">
      <i class="bi bi-pencil"></i> Editar
    </a>
    <a href="/certificados/imprimir/{{certificado.id}}" class="btn btn-primary" target="_blank">
      <i class="bi bi-printer"></i> Imprimir
    </a>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <!-- Información Principal del Certificado -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Información del Certificado</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <strong>Número:</strong><br>
            <span class="fs-4">{{certificado.numero}}</span>
          </div>
          <div class="col-md-6">
            <strong>Estado:</strong><br>
            <span class="badge {{getEstadoCertificadoBadge certificado.estado}} fs-6">
              {{getEstadoCertificado certificado.estado}}
            </span>
          </div>
        </div>
        
        <hr>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>Descripción/Alcance:</strong><br>
            <p>{{certificado.alcance}}</p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>Condiciones:</strong><br>
            <p>{{#if certificado.condiciones}}{{certificado.condiciones}}{{else}}<em>No especificadas</em>{{/if}}</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>Fecha de Emisión:</strong><br>
            {{formatDate certificado.fecha}}
          </div>
          <div class="col-md-6 mb-3">
            <strong>Fecha de Factura:</strong><br>
            {{#if certificado.fecha_factura}}{{formatDate certificado.fecha_factura}}{{else}}<em>No facturado</em>{{/if}}
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-4 mb-3">
            <strong>Cantidad:</strong><br>
            {{#if certificado.cantidad}}{{certificado.cantidad}}{{else}}1{{/if}}
          </div>
          <div class="col-md-4 mb-3">
            <strong>Precio Unitario:</strong><br>
            {{formatCurrency certificado.precio_unitario}}
          </div>
          <div class="col-md-4 mb-3">
            <strong>Importe Total:</strong><br>
            <span class="fs-5 fw-bold text-success">{{formatCurrency certificado.importe}}</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Proyecto Asociado -->
    {{#if proyecto}}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-folder"></i> Proyecto Asociado</h5>
      </div>
      <div class="card-body">
        <h6><a href="/proyectos/ver/{{proyecto.id}}">{{proyecto.nombre}}</a></h6>
        <div class="row">
          <div class="col-md-6">
            <strong>Presupuesto:</strong> {{formatCurrency proyecto.presupuesto}}
          </div>
          <div class="col-md-6">
            <strong>Estado:</strong>
            <span class="badge {{#eq proyecto.estado 1}}bg-info{{/eq}}{{#eq proyecto.estado 2}}bg-warning{{/eq}}{{#eq proyecto.estado 3}}bg-success{{/eq}} ms-2">
              {{#eq proyecto.estado 1}}Planificado{{/eq}}
              {{#eq proyecto.estado 2}}En Progreso{{/eq}}
              {{#eq proyecto.estado 3}}Completado{{/eq}}
            </span>
          </div>
        </div>
      </div>
    </div>
    {{/if}}
    
    <!-- Otros Certificados del Mismo Proyecto -->
    {{#if otrosCertificadosProyecto}}
    {{#if (gt otrosCertificadosProyecto.length 0)}}
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Otros Certificados del Proyecto ({{otrosCertificadosProyecto.length}})</h6>
      </div>
      <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
        {{#each otrosCertificadosProyecto}}
        <a href="/certificados/ver/{{this.id}}" class="list-group-item list-group-item-action">
          <div class="d-flex justify-content-between">
            <span><strong>N° {{this.numero}}</strong></span>
            <span class="badge {{getEstadoCertificadoBadge this.estado}}">{{getEstadoCertificado this.estado}}</span>
          </div>
          <small class="text-muted">{{formatDate this.fecha}}</small>
        </a>
        {{/each}}
      </div>
    </div>
    {{/if}}
    {{/if}}
    
    <!-- Otros Proyectos del Cliente -->
    {{#if otrosProyectosCliente}}
    {{#if (gt otrosProyectosCliente.length 0)}}
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h6 class="mb-0"><i class="bi bi-briefcase"></i> Otros Proyectos del Cliente ({{otrosProyectosCliente.length}})</h6>
      </div>
      <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
        {{#each otrosProyectosCliente}}
        <a href="/proyectos/ver/{{this.id}}" class="list-group-item list-group-item-action">
          <div class="d-flex justify-content-between">
            <span><strong>{{this.nombre}}</strong></span>
            <span class="badge bg-secondary">{{this.descripcion}}</span>
          </div>
          <small class="text-muted">Presupuesto: {{formatCurrency this.presupuesto}}</small>
        </a>
        {{/each}}
      </div>
    </div>
    {{/if}}
    {{/if}}
  </div>
  
  <!-- Sidebar Derecho: Cliente e Información Relacionada -->
  <div class="col-lg-4">
    <!-- Información del Cliente -->
    {{#if certificado.cliente_nombre}}
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-person-circle"></i> Cliente</h5>
      </div>
      <div class="card-body">
        <h6>{{certificado.cliente_nombre}}</h6>
        {{#if totalCertificadosCliente}}
        <div class="mt-3">
          <small class="text-muted">Estadísticas del Cliente:</small>
          <ul class="list-unstyled mt-2">
            <li><strong>Total Certificados:</strong> {{totalCertificadosCliente}}</li>
            <li><strong>Monto Total:</strong> {{formatCurrency montoTotalCliente}}</li>
          </ul>
          <a href="/certificados?cliente_id={{certificado.cliente_id}}&cliente_display={{certificado.cliente_nombre}}" class="btn btn-sm btn-outline-primary w-100">
            <i class="bi bi-search"></i> Ver todos sus certificados
          </a>
        </div>
        {{/if}}
      </div>
    </div>
    {{else}}
    <div class="card mb-4">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Sin Cliente</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">Este certificado no tiene cliente asociado.</p>
      </div>
    </div>
    {{/if}}
    
    <!-- Acciones -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Acciones</h5>
      </div>
      <div class="card-body d-grid gap-2">
        {{#eq certificado.estado 0}}
        <button type="button" class="btn btn-primary" onclick="cambiarEstado(1)">
          <i class="bi bi-check-circle"></i> Enviar para Aprobación
        </button>
        {{/eq}}
        
        {{#eq certificado.estado 1}}
        <button type="button" class="btn btn-success" onclick="cambiarEstado(2)">
          <i class="bi bi-check2-circle"></i> Aprobar Certificado
        </button>
        <button type="button" class="btn btn-danger" onclick="cambiarEstado(4)">
          <i class="bi bi-x-circle"></i> Rechazar Certificado
        </button>
        {{/eq}}
        
        {{#eq certificado.estado 2}}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#facturarModal">
          <i class="bi bi-receipt"></i> Facturar Certificado
        </button>
        {{/eq}}
        
        {{#if (ne certificado.estado 4)}}
        <a href="/certificados/editar/{{certificado.id}}?return={{returnUrl}}" class="btn btn-warning">
          <i class="bi bi-pencil"></i> Editar
        </a>
        {{/if}}
        
        <a href="/certificados/imprimir/{{certificado.id}}" class="btn btn-outline-primary" target="_blank">
          <i class="bi bi-printer"></i> Imprimir/PDF
        </a>
        
        <hr>
        <a href="{{returnUrl}}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Facturar Certificado -->
<div class="modal fade" id="facturarModal" tabindex="-1" aria-labelledby="facturarModalLabel" aria-hidden="true" style="z-index: 1055;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="facturarModalLabel">Facturar Certificado N° {{certificado.numero}}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="facturarForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <label for="tipo_factura" class="form-label">Tipo de Factura</label>
              <select class="form-select" id="tipo_factura" name="tipo_factura" required>
                <option value="">Seleccionar tipo</option>
                <option value="A">Factura A</option>
                <option value="B">Factura B</option>
                <option value="C">Factura C</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="punto_venta" class="form-label">Punto de Venta</label>
              <input type="number" class="form-control" id="punto_venta" name="punto_venta" value="1" required>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-12">
              <div class="alert alert-info">
                <strong>Resumen:</strong> Importe: {{formatCurrency certificado.importe}} | 
                IVA (21%): {{formatCurrency (multiply certificado.importe 0.21)}} | 
                Total: {{formatCurrency (multiply certificado.importe 1.21)}}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Generar Factura</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function cambiarEstado(nuevoEstado) {
  const estadoTexto = {
    1: 'Borrador',
    2: 'Pendiente de Aprobación', 
    3: 'Aprobado',
    4: 'Facturado',
    5: 'Rechazado'
  };
  
  if (confirm(`¿Está seguro de cambiar el estado del certificado a "${estadoTexto[nuevoEstado]}"?`)) {
    // Show loading state
    const buttons = document.querySelectorAll('button[onclick*="cambiarEstado"]');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Procesando...';
    });
    
    fetch(`/api/certificados/{{certificado.id}}/estado`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message || 'Estado actualizado correctamente');
        location.reload();
      } else {
        alert('Error: ' + (data.message || 'Error desconocido'));
        // Re-enable buttons
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.innerHTML = btn.getAttribute('data-original-text');
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error de conexión al actualizar el estado');
      // Re-enable buttons
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = btn.getAttribute('data-original-text');
      });
    });
  }
}

document.getElementById('facturarForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  data.certificado_id = '{{certificado.id}}';
  
  fetch('/api/facturas/generar-desde-certificado', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Factura generada exitosamente');
      window.location.href = `/facturas/ver/${data.factura_id}`;
    } else {
      alert('Error: ' + data.message);
    }
  });
});
</script>
