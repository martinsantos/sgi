<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2">{{proyecto.nombre}}</h1>
        <p class="text-muted mb-0">Proyecto #{{proyecto.id}}</p>
    </div>
    <div>
        <a href="/proyectos" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left"></i> Volver al Listado
        </a>
        <a href="/proyectos/editar/{{proyecto.id}}" class="btn btn-warning me-2">
            <i class="bi bi-pencil"></i> Editar
        </a>
        <button class="btn btn-primary" onclick="window.print()">
            <i class="bi bi-printer"></i> Imprimir
        </button>
    </div>
</div>

<!-- Status and Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h5 class="card-title mb-1">Estado</h5>
                <span class="badge {{proyecto.estado_badge_class}} fs-6">
                    {{#eq proyecto.estado 1}}Pendiente{{/eq}}
                    {{#eq proyecto.estado 2}}En Progreso{{/eq}}
                    {{#eq proyecto.estado 3}}Finalizado{{/eq}}
                    {{#eq proyecto.estado 4}}Cancelado{{/eq}}
                </span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h5 class="card-title mb-1">Presupuesto</h5>
                <h4 class="text-success mb-0">${{proyecto.presupuesto}}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h5 class="card-title mb-1">Certificados</h5>
                <h4 class="text-info mb-0">{{certificados.length}}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h5 class="card-title mb-1">Duración</h5>
                <h4 class="text-primary mb-0">
                    {{#if proyecto.fecha_cierre}}
                        -- días días
                    {{else}}
                        -- días días
                    {{/if}}
                </h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Project Details -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información del Proyecto</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold text-muted">Descripción:</label>
                        <p class="mb-0">{{proyecto.descripcion}}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold text-muted">Cliente:</label>
                        <p class="mb-0">
                            {{#if proyecto.cliente_id}}
                                <a href="/clientes/ver/{{proyecto.cliente_id}}" class="text-decoration-none">
                                    {{proyecto.cliente_nombre}}
                                </a>
                            {{else}}
                                {{proyecto.cliente_nombre}}
                            {{/if}}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold text-muted">Fecha de Inicio:</label>
                        <p class="mb-0">{{proyecto.fecha_inicio}}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold text-muted">Fecha de Cierre:</label>
                        <p class="mb-0">
                            {{#if proyecto.fecha_cierre}}
                                {{formatDate proyecto.fecha_cierre}}
                            {{else}}
                                <em class="text-muted">En progreso</em>
                            {{/if}}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-award"></i> Certificados del Proyecto</h5>
                <div class="btn-group btn-group-sm">
                    <a href="/certificados/nuevo?proyecto={{proyecto.id}}" class="btn btn-success">
                        <i class="bi bi-plus"></i> Nuevo Certificado
                    </a>
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#asociarCertificadoModal">
                        <i class="bi bi-link"></i> Asociar Existentes
                    </button>
                </div>
            </div>
            <div class="card-body">
                {{#if certificados.activos}}
                <!-- CERTIFICADOS ACTIVOS -->
                <div class="mb-4">
                    <h6 class="text-success fw-bold mb-3">
                        <i class="bi bi-check-circle"></i> Certificados Activos ({{certificados.total_activos}})
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Certificado</th>
                                    <th>Descripción</th>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each certificados.activos}}
                                <tr>
                                    <td>
                                        <strong>#{{this.numero}}</strong>
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{this.alcance}}</div>
                                        {{#if this.condiciones}}
                                            <small class="text-muted">{{this.condiciones}}</small>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <small>{{formatDate this.fecha}}</small>
                                        {{#if this.fecha_factura}}
                                            <small class="text-muted d-block">Fact: {{formatDate this.fecha_factura}}</small>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <span class="fw-bold text-success">${{this.importe}}</span>
                                    </td>
                                    <td>
                                        {{#if (eq this.estado 0)}}
                                            <span class="badge bg-warning text-dark" style="padding: 0.6rem 0.85rem; font-weight: 700; font-size: 0.9rem;">Pendiente</span>
                                        {{else if (eq this.estado 1)}}
                                            <span class="badge bg-primary text-white" style="padding: 0.6rem 0.85rem; font-weight: 700; font-size: 0.9rem;">Aprobado</span>
                                        {{else if (eq this.estado 2)}}
                                            <span class="badge bg-success text-white" style="padding: 0.6rem 0.85rem; font-weight: 700; font-size: 0.9rem;">Facturado</span>
                                        {{else if (eq this.estado 3)}}
                                            <span class="badge bg-info text-white" style="padding: 0.6rem 0.85rem; font-weight: 700; font-size: 0.9rem;">En Proceso</span>
                                        {{else if (eq this.estado 4)}}
                                            <span class="badge bg-danger text-white" style="padding: 0.6rem 0.85rem; font-weight: 700; font-size: 0.9rem;">Anulado</span>
                                        {{else}}
                                            <span class="badge bg-secondary text-white" style="padding: 0.6rem 0.85rem; font-weight: 700; font-size: 0.9rem;">Desconocido</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/certificados/ver/{{this.id}}?return=/proyectos/ver/{{../proyecto.id}}" class="btn btn-outline-primary" title="Ver detalle">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="/certificados/editar/{{this.id}}?return=/proyectos/ver/{{../proyecto.id}}" class="btn btn-outline-warning" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-desasociar" data-cert-id="{{this.id}}" title="Desasociar">
                                                <i class="bi bi-unlink"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
                {{/if}}

                {{#if certificados.inactivos}}
                <!-- CERTIFICADOS INACTIVOS -->
                <div class="mb-4">
                    <h6 class="text-danger fw-bold mb-3">
                        <i class="bi bi-x-circle"></i> Certificados Inactivos ({{certificados.total_inactivos}})
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm opacity-75">
                            <thead class="table-light">
                                <tr>
                                    <th>Certificado</th>
                                    <th>Descripción</th>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each certificados.inactivos}}
                                <tr>
                                    <td>
                                        <strong>#{{this.numero}}</strong>
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{this.alcance}}</div>
                                    </td>
                                    <td><small>{{formatDate this.fecha}}</small></td>
                                    <td>
                                        <span class="fw-bold text-success">${{this.importe}}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">Inactivo</span>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
                {{/if}}

                {{#if certificados.activos}}
                <!-- Certificates Summary -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Certificados</h6>
                                <h4 class="mb-0">{{certificados.total}}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Activos</h6>
                                <h4 class="mb-0 text-success">{{certificados.total_activos}}</h4>
                            </div>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="text-center py-4">
                    <i class="bi bi-award" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="text-muted mt-2 mb-3">No hay certificados asociados a este proyecto</p>
                    <div class="btn-group">
                        <a href="/certificados/nuevo?proyecto={{proyecto.id}}" class="btn btn-primary">
                            <i class="bi bi-plus"></i> Crear Primer Certificado
                        </a>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#asociarCertificadoModal">
                            <i class="bi bi-link"></i> Asociar Existentes
                        </button>
                    </div>
                </div>
                {{/if}}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Project Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Acciones del Proyecto</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/proyectos/editar/{{proyecto.id}}" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Editar Proyecto
                    </a>
                    <a href="/certificados/nuevo?proyecto={{proyecto.id}}" class="btn btn-success">
                        <i class="bi bi-award"></i> Nuevo Certificado
                    </a>
                    {{#if proyecto.cliente_id}}
                    <a href="/clientes/ver/{{proyecto.cliente_id}}" class="btn btn-outline-info">
                        <i class="bi bi-person"></i> Ver Cliente
                    </a>
                    {{/if}}
                    <hr>
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimir Proyecto
                    </button>
                    <a href="/proyectos/reporte/{{proyecto.id}}" class="btn btn-outline-secondary">
                        <i class="bi bi-file-earmark-pdf"></i> Generar Reporte
                    </a>
                </div>
            </div>
        </div>

        <!-- Project Timeline -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Timeline</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Proyecto Creado</h6>
                            <small class="text-muted">{{proyecto.fecha_inicio}}</small>
                        </div>
                    </div>
                    
                    {{#if certificados.activos}}
                    {{#each certificados.activos}}
                    <div class="timeline-item">
                        <div class="timeline-marker {{#eq this.estado 2}}bg-success{{else}}bg-warning{{/eq}}"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Certificado #{{this.numero}}</h6>
                            <small class="text-muted">{{formatDate this.fecha}}</small>
                            <div class="mt-1">
                                {{#if (eq this.estado 0)}}
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                {{else if (eq this.estado 1)}}
                                    <span class="badge bg-primary text-white">Aprobado</span>
                                {{else if (eq this.estado 2)}}
                                    <span class="badge bg-success text-white">Facturado</span>
                                {{else if (eq this.estado 3)}}
                                    <span class="badge bg-info text-white">En Proceso</span>
                                {{else if (eq this.estado 4)}}
                                    <span class="badge bg-danger text-white">Anulado</span>
                                {{else}}
                                    <span class="badge bg-secondary text-white">Desconocido</span>
                                {{/if}}
                            </div>
                        </div>
                    </div>
                    {{/each}}
                    {{/if}}
                    
                    {{#if proyecto.fecha_cierre}}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Proyecto Finalizado</h6>
                            <small class="text-muted">{{formatDate proyecto.fecha_cierre}}</small>
                        </div>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asociar Certificados -->
<div class="modal fade" id="asociarCertificadoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asociar Certificados Existentes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="buscarCertificado" placeholder="Buscar por número o descripción...">
                </div>
                <div id="certificadosDisponibles" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 1.5rem;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -1.5rem;
    top: 0;
    bottom: -1.5rem;
    width: 2px;
    background: #e9ecef;
}

.timeline-item:last-child::before {
    display: none;
}

.timeline-marker {
    position: absolute;
    left: -1.75rem;
    top: 0.25rem;
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e9ecef;
}

.timeline-content {
    padding-left: 0.5rem;
}

.cert-item {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.cert-item:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
}

.cert-item.selected {
    background-color: #e7f1ff;
    border-color: #0d6efd;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const proyectoId = '{{proyecto.id}}';
    const modal = document.getElementById('asociarCertificadoModal');
    const buscarInput = document.getElementById('buscarCertificado');
    const certificadosDiv = document.getElementById('certificadosDisponibles');
    let certificadosCache = [];

    // Cargar certificados cuando se abre el modal
    modal.addEventListener('show.bs.modal', function() {
        cargarCertificadosDisponibles();
    });

    // Buscar mientras se escribe
    buscarInput.addEventListener('input', function() {
        filtrarCertificados(this.value);
    });

    async function cargarCertificadosDisponibles() {
        try {
            const response = await fetch(`/proyectos/${proyectoId}/certificados-disponibles?limit=100`);
            const data = await response.json();
            
            if (data.success) {
                certificadosCache = data.data;
                mostrarCertificados(certificadosCache);
            }
        } catch (error) {
            console.error('Error cargando certificados:', error);
            certificadosDiv.innerHTML = '<div class="alert alert-danger">Error al cargar certificados</div>';
        }
    }

    function mostrarCertificados(certificados) {
        if (certificados.length === 0) {
            certificadosDiv.innerHTML = '<div class="alert alert-info">No hay certificados disponibles para asociar</div>';
            return;
        }

        certificadosDiv.innerHTML = certificados.map(cert => `
            <div class="cert-item" data-cert-id="${cert.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>#${cert.numero}</strong>
                        <div class="small text-muted">${cert.alcance || 'Sin descripción'}</div>
                        <div class="small">
                            <span class="badge bg-secondary">${cert.estado_nombre}</span>
                            <span class="text-muted ms-2">${cert.fecha}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">$${parseFloat(cert.importe).toLocaleString('es-AR')}</div>
                        <button class="btn btn-sm btn-primary mt-2 btn-asociar" data-cert-id="${cert.id}">
                            <i class="bi bi-link"></i> Asociar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        // Agregar event listeners a los botones
        document.querySelectorAll('.btn-asociar').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                asociarCertificado(this.dataset.certId);
            });
        });
    }

    function filtrarCertificados(texto) {
        const filtrados = certificadosCache.filter(cert => 
            cert.numero.toString().includes(texto) ||
            (cert.alcance && cert.alcance.toLowerCase().includes(texto.toLowerCase()))
        );
        mostrarCertificados(filtrados);
    }

    async function asociarCertificado(certificadoId) {
        try {
            const response = await fetch(`/proyectos/${proyectoId}/asociar-certificado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ certificadoId })
            });

            const data = await response.json();
            
            if (data.success) {
                alert('Certificado asociado exitosamente');
                // Recargar la página para ver los cambios
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error asociando certificado:', error);
            alert('Error al asociar el certificado');
        }
    }

    // Desasociar certificado
    document.querySelectorAll('.btn-desasociar').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('¿Desasociar este certificado del proyecto?')) return;

            try {
                const response = await fetch(`/proyectos/${proyectoId}/desasociar-certificado`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ certificadoId: this.dataset.certId })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Certificado desasociado exitosamente');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error desasociando certificado:', error);
                alert('Error al desasociar el certificado');
            }
        });
    });
});
</script>
