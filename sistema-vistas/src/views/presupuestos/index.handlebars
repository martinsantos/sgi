{{!-- Presupuestos Comerciales Index --}}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">{{title}}</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoPresupuestoModal">
          <i class="fas fa-plus me-2"></i>Nuevo Presupuesto
        </button>
      </div>
    </div>
  </div>

  {{!-- Filters --}}
  <div class="row mb-4">
    <div class="col">
      <div class="card">
        <div class="card-body">
          <form class="row g-3" id="filtros-form">
            <div class="col-md-3">
              <label for="estado" class="form-label">Estado</label>
              <select class="form-select" id="estado" name="estado">
                <option value="">Todos los estados</option>
                <option value="borrador">Borrador</option>
                <option value="enviado">Enviado</option>
                <option value="aprobado">Aprobado</option>
                <option value="rechazado">Rechazado</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="cliente" class="form-label">Cliente</label>
              <select class="form-select" id="cliente" name="cliente">
                <option value="">Todos los clientes</option>
                {{#each clientes}}
                <option value="{{id}}">{{nombre}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-3">
              <label for="fecha" class="form-label">Fecha</label>
              <input type="date" class="form-control" id="fecha" name="fecha">
            </div>
            <div class="col-md-3">
              <label for="search" class="form-label">Buscar</label>
              <input type="text" class="form-control" id="search" name="search" placeholder="Buscar presupuesto...">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {{!-- Presupuestos Table --}}
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="presupuestos-table">
              <thead class="table-dark">
                <tr>
                  <th style="cursor: pointer;" class="sortable" data-sort="numero_presupuesto">Número <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th style="cursor: pointer;" class="sortable" data-sort="cliente_nombre">Cliente <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th style="cursor: pointer;" class="sortable" data-sort="descripcion">Título <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th style="cursor: pointer;" class="sortable" data-sort="fecha_emision">Fecha <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th style="cursor: pointer;" class="sortable" data-sort="fecha_validez">Vencimiento <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th style="cursor: pointer;" class="sortable" data-sort="estado_nombre">Estado <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th style="cursor: pointer;" class="sortable" data-sort="importe_total">Valor Total <i class="bi bi-arrow-down-up ms-1"></i></th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {{#each presupuestos}}
                <tr>
                  <td><strong>{{numero_presupuesto}}</strong></td>
                  <td>{{#if cliente_nombre}}<a href="/clientes/ver/{{cliente_id}}" class="client-link text-decoration-none">{{cliente_nombre}}</a>{{else}}<span class="text-muted">Sin cliente asignado</span>{{/if}}</td>
                  <td>{{descripcion}}</td>
                  <td>{{fecha_emision_formatted}}</td>
                  <td>
                    {{fecha_validez_formatted}}
                    {{#if (lt dias_hasta_vencimiento 0)}}
                    <span class="badge bg-danger ms-2">Vencido</span>
                    {{else if (lt dias_hasta_vencimiento 7)}}
                    <span class="badge bg-warning ms-2">{{dias_hasta_vencimiento}} días</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if estado_nombre}}
                      <span class="badge {{estado_badge_class}}">{{estado_nombre}}</span>
                    {{else}}
                      <span class="text-muted">Sin estado</span>
                    {{/if}}
                  </td>
                  <td><strong>{{importe_total_formatted}}</strong></td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="/presupuestos/ver/{{id}}" class="btn btn-outline-primary" title="Ver">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="/presupuestos/editar/{{id}}" class="btn btn-outline-warning" title="Editar">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <button type="button" class="btn btn-outline-danger"
                              title="Eliminar"
                              onclick="abrirModalEliminar('{{id}}', '{{numero_presupuesto}}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {{else}}
                <tr>
                  <td colspan="9" class="text-center text-muted">No se encontraron presupuestos</td>
                </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sortable headers - Ordenamiento personalizado
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function(e) {
            e.preventDefault();
            const sortField = this.dataset.sort;
            const currentSort = new URLSearchParams(window.location.search).get('sort');
            const currentOrder = new URLSearchParams(window.location.search).get('order');
            
            let newOrder = 'asc';
            if (currentSort === sortField && currentOrder === 'asc') {
                newOrder = 'desc';
            }
            
            const params = new URLSearchParams(window.location.search);
            params.set('sort', sortField);
            params.set('order', newOrder);
            // Remover página para volver a la primera
            params.delete('page');
            window.location.href = window.location.pathname + '?' + params.toString();
        });
    });

    // Filter form handling
    document.getElementById('filtros-form').addEventListener('change', function() {
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        // Remover página para volver a la primera al filtrar
        params.delete('page');
        window.location.href = window.location.pathname + '?' + params.toString();
    });
});

function abrirModalEliminar(presupuestoId, numeroPresupuesto) {
    const modalHTML = `
        <div class="modal fade" id="modalEliminarPresupuesto" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Eliminar Presupuesto
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            <strong>Advertencia:</strong> Esta acción no se puede deshacer.
                        </div>
                        <p class="mb-3">
                            ¿Está seguro de que desea eliminar el presupuesto <strong>#${numeroPresupuesto}</strong>?
                        </p>
                        <p class="text-muted mb-0">
                            Para confirmar, escriba la palabra <strong>ELIMINAR</strong> en el campo de abajo:
                        </p>
                    </div>
                    <div class="modal-body border-top">
                        <input type="text"
                               id="confirmacionTexto"
                               class="form-control"
                               placeholder="Escriba ELIMINAR para confirmar"
                               onkeyup="validarConfirmacion()">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="button"
                                id="btnConfirmarEliminar"
                                class="btn btn-danger"
                                disabled
                                onclick="confirmarEliminacionPresupuesto('${presupuestoId}')">
                            <i class="bi bi-trash me-1"></i>Eliminar Presupuesto
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingModal = document.getElementById('modalEliminarPresupuesto');
    if (existingModal) {
        existingModal.remove();
    }

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    const modal = new bootstrap.Modal(document.getElementById('modalEliminarPresupuesto'));
    modal.show();

    document.getElementById('modalEliminarPresupuesto').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function validarConfirmacion() {
    const texto = document.getElementById('confirmacionTexto').value;
    const btnConfirmar = document.getElementById('btnConfirmarEliminar');

    btnConfirmar.disabled = texto !== 'ELIMINAR';
}

function confirmarEliminacionPresupuesto(presupuestoId) {
    const btnConfirmar = document.getElementById('btnConfirmarEliminar');
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Eliminando...';

    fetch(`/presupuestos/${presupuestoId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const alertHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Éxito:</strong> Presupuesto eliminado correctamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', alertHTML);

            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminarPresupuesto'));
            modal.hide();

            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Error al eliminar presupuesto: ' + data.message);
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="bi bi-trash me-1"></i>Eliminar Presupuesto';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar el presupuesto');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="bi bi-trash me-1"></i>Eliminar Presupuesto';
    });
}
</script>
