<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h3 mb-2">{{cliente.nombre}}</h1>
                    <div class="mb-2">
                        {{#if cliente.codigo}}
                        <span class="badge bg-secondary me-2">{{cliente.codigo}}</span>
                        {{/if}}
                        {{#if cliente.tipo_persona}}
                        <span class="badge {{#if (eq cliente.tipo_persona 'F')}}bg-info{{else}}bg-success{{/if}} me-2">
                            {{#if (eq cliente.tipo_persona 'F')}}Persona Física{{else}}Persona Jurídica{{/if}}
                        </span>
                        {{/if}}
                        {{#if cliente.activo}}
                        <span class="badge bg-success">Activo</span>
                        {{else}}
                        <span class="badge bg-danger">Inactivo</span>
                        {{/if}}
                    </div>
                    <p class="text-muted mb-0 small">Cliente desde {{formatDate cliente.created}}</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="/clientes" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                    <a href="/clientes/editar/{{cliente.id}}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    <a href="/facturas/crear?cliente_id={{cliente.id}}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle"></i> Nueva Factura
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-receipt text-primary fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-1 text-success">{{formatCurrency cliente.resumen_financiero.facturas.total_facturado}}</h5>
                            <p class="mb-0 text-muted small">Total Facturado</p>
                            <small class="text-success">
                                {{formatNumber cliente.resumen_financiero.facturas.total_facturas}} facturas
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-clock text-warning fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-1 text-warning">{{formatCurrency cliente.resumen_financiero.facturas.pendiente_cobro}}</h5>
                            <p class="mb-0 text-muted small">Pendiente Cobro</p>
                            <small class="text-muted">
                                {{calcularPorcentaje cliente.resumen_financiero.facturas.pendiente_cobro cliente.resumen_financiero.facturas.total_facturado}}% del total
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-kanban text-info fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-1">{{formatNumber cliente.resumen_financiero.proyectos.total_proyectos}}</h5>
                            <p class="mb-0 text-muted small">Proyectos</p>
                            <small class="text-info">
                                {{formatNumber cliente.resumen_financiero.proyectos.proyectos_activos}} activos
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-award text-success fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-1">{{formatNumber cliente.resumen_financiero.certificados.total_certificados}}</h5>
                            <p class="mb-0 text-muted small">Certificados</p>
                            <small class="text-success">
                                {{formatCurrency cliente.resumen_financiero.certificados.valor_total_certificados}}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column - Contact Info -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-circle me-2"></i>Información del Cliente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small text-muted">Tipo de Persona</label>
                            <div>
                                <span class="badge {{getBadgeClass cliente.tipo_persona}}">
                                    {{cliente.tipo_persona}}
                                </span>
                            </div>
                        </div>

                        {{#if cliente.email}}
                        <div class="col-12">
                            <label class="form-label small text-muted">Email</label>
                            <div>
                                <i class="bi bi-envelope me-2"></i>
                                <a href="mailto:{{cliente.email}}">{{cliente.email}}</a>
                            </div>
                        </div>
                        {{/if}}

                        {{#if cliente.telefono}}
                        <div class="col-12">
                            <label class="form-label small text-muted">Teléfono</label>
                            <div>
                                <i class="bi bi-phone me-2"></i>
                                <a href="tel:{{cliente.telefono}}">{{cliente.telefono}}</a>
                            </div>
                        </div>
                        {{/if}}

                        {{#if cliente.direccion}}
                        <div class="col-12">
                            <label class="form-label small text-muted">Dirección</label>
                            <div>
                                <i class="bi bi-geo-alt me-2"></i>
                                {{cliente.direccion}}
                                {{#if cliente.codigo_postal}}
                                <br><small class="text-muted">CP: {{cliente.codigo_postal}}</small>
                                {{/if}}
                            </div>
                        </div>
                        {{/if}}

                        {{#if cliente.cuil_cuit}}
                        <div class="col-12">
                            <label class="form-label small text-muted">CUIT/CUIL</label>
                            <div>{{cliente.cuil_cuit}}</div>
                        </div>
                        {{/if}}

                        {{#if cliente.condicion_iva}}
                        <div class="col-12">
                            <label class="form-label small text-muted">Condición IVA</label>
                            <div>{{getCondicionIva cliente.condicion_iva}}</div>
                        </div>
                        {{/if}}

                        <div class="col-12">
                            <label class="form-label small text-muted">Estado</label>
                            <div>
                                {{#if cliente.activo}}
                                <span class="badge bg-success">Activo</span>
                                {{else}}
                                <span class="badge bg-danger">Inactivo</span>
                                {{/if}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Tabs Content -->
        <div class="col-lg-8">
            <!-- Navigation Tabs -->
            <ul class="nav nav-pills nav-fill mb-3" id="clienteTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="facturas-tab" data-bs-toggle="pill" data-bs-target="#facturas" type="button" role="tab">
                        <i class="bi bi-receipt me-2"></i>Facturas ({{cliente.facturas.length}})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="proyectos-tab" data-bs-toggle="pill" data-bs-target="#proyectos" type="button" role="tab">
                        <i class="bi bi-kanban me-2"></i>Proyectos ({{cliente.proyectos.length}})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="certificados-tab" data-bs-toggle="pill" data-bs-target="#certificados" type="button" role="tab">
                        <i class="bi bi-award me-2"></i>Certificados ({{cliente.certificados.length}})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="presupuestos-tab" data-bs-toggle="pill" data-bs-target="#presupuestos" type="button" role="tab">
                        <i class="bi bi-file-earmark-text me-2"></i>Presupuestos ({{cliente.presupuestos.length}})
                    </button>
                </li>
            </ul>

    <!-- Historial de Facturas -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Historial de Facturas</h5>
        <small class="text-muted">{{cliente.facturas.length}} facturas</small>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>N° Factura</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th class="text-end">Monto</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each cliente.facturas}}
              <tr>
                <td>{{this.numero_factura_completo}}</td>
                <td>{{formatDate this.fecha_emision}}</td>
                <td>
                  <span class="badge {{#eq this.tipo_factura 'A'}}bg-primary{{else}}bg-secondary{{/eq}}">
                    {{this.tipo_factura}}
                  </span>
                </td>
                <td class="text-end">{{formatCurrency this.total}}</td>
                <td>
                  <span class="badge {{#eq this.estado 1}}bg-warning{{/eq}}{{#eq this.estado 3}}bg-success{{/eq}}">
                    {{#eq this.estado 1}}Pendiente{{/eq}}
                    {{#eq this.estado 3}}Cobrada{{/eq}}
                  </span>
                </td>
                <td>
                  <a href="/facturas/detalle/{{this.id}}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {{else}}
              <tr>
                <td colspan="6" class="text-center text-muted py-3">
                  No hay facturas registradas para este cliente
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
        {{#if cliente.facturas}}
        <div class="text-end mt-3">
          <a href="/facturas/emitidas?cliente={{cliente.id}}" class="btn btn-sm btn-outline-primary">
            Ver todas las facturas
          </a>
        </div>
        {{/if}}
      </div>
    </div>

    <!-- Proyectos Asociados -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Proyectos</h5>
        <small class="text-muted">{{cliente.proyectos.length}} proyectos</small>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Proyecto</th>
                <th>Fecha Inicio</th>
                <th>Estado</th>
                <th class="text-end">Presupuesto</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each cliente.proyectos}}
              <tr>
                <td>
                  <strong>{{this.nombre}}</strong>
                  {{#if this.descripcion}}
                  <small class="text-muted d-block">{{this.descripcion}}</small>
                  {{/if}}
                </td>
                <td>{{formatDate this.fecha_inicio}}</td>
                <td>
                  <span class="badge {{#eq this.estado 1}}bg-warning{{/eq}}{{#eq this.estado 2}}bg-info{{/eq}}{{#eq this.estado 3}}bg-success{{/eq}}">
                    {{#eq this.estado 1}}Pendiente{{/eq}}
                    {{#eq this.estado 2}}En Progreso{{/eq}}
                    {{#eq this.estado 3}}Finalizado{{/eq}}
                  </span>
                </td>
                <td class="text-end">{{formatCurrency this.presupuesto}}</td>
                <td>
                  <a href="/proyectos/ver/{{this.id}}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {{else}}
              <tr>
                <td colspan="5" class="text-center text-muted py-3">
                  No hay proyectos registrados para este cliente
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Certificados -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Certificados</h5>
        <small class="text-muted">{{cliente.certificados.length}} certificados</small>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>N° Certificado</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th class="text-end">Monto</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each cliente.certificados}}
              <tr>
                <td>{{this.numero_certificado}}</td>
                <td>{{formatDate this.fecha_emision}}</td>
                <td>
                  <span class="badge bg-info">{{this.tipo}}</span>
                </td>
                <td class="text-end">{{formatCurrency this.monto}}</td>
                <td>
                  <span class="badge {{#eq this.estado 3}}bg-success{{else}}bg-warning{{/eq}}">
                    {{#eq this.estado 1}}Pendiente{{/eq}}
                    {{#eq this.estado 2}}En Revisión{{/eq}}
                    {{#eq this.estado 3}}Aprobado{{/eq}}
                  </span>
                </td>
                <td>
                  <a href="/certificados/ver/{{this.id}}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {{else}}
              <tr>
                <td colspan="6" class="text-center text-muted py-3">
                  No hay certificados registrados para este cliente
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <!-- Resumen -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Resumen</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <h4 class="text-primary">{{resumen.total_facturas}}</h4>
            <small class="text-muted">Facturas</small>
          </div>
          <div class="col-6">
            <h4 class="text-success">{{formatCurrency resumen.total_facturado}}</h4>
            <small class="text-muted">Facturado</small>
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-6">
            <h4 class="text-info">{{resumen.proyectos_activos}}</h4>
            <small class="text-muted">Proyectos Activos</small>
          </div>
          <div class="col-6">
            <h4 class="text-warning">{{formatCurrency resumen.pendiente_cobro}}</h4>
            <small class="text-muted">Pend. Cobro</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Actividad Reciente -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Actividad Reciente</h5>
      </div>
      <div class="card-body">
        <div class="timeline">
          {{#each actividad_reciente}}
          <div class="timeline-item mb-3">
            <div class="timeline-marker bg-{{this.tipo_class}}"></div>
            <div class="timeline-content">
              <small class="text-muted">{{formatDate this.fecha}}</small>
              <p class="mb-1"><strong>{{this.titulo}}</strong></p>
              <small class="text-muted">{{this.descripcion}}</small>
            </div>
          </div>
          {{else}}
          <p class="text-muted text-center">No hay actividad reciente</p>
          {{/each}}
        </div>
      </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Acciones Rápidas</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/facturas/nueva?cliente={{cliente.id}}" class="btn btn-primary btn-sm">
            <i class="bi bi-receipt"></i> Nueva Factura
          </a>
          <a href="/proyectos/nuevo?cliente={{cliente.id}}" class="btn btn-info btn-sm">
            <i class="bi bi-folder-plus"></i> Nuevo Proyecto
          </a>
          <a href="/certificados/nuevo?cliente={{cliente.id}}" class="btn btn-secondary btn-sm">
            <i class="bi bi-award"></i> Nuevo Certificado
          </a>
          <hr>
          <a href="mailto:{{cliente.email}}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-envelope"></i> Enviar Email
          </a>
          <a href="tel:{{cliente.telefono}}" class="btn btn-outline-success btn-sm">
            <i class="bi bi-telephone"></i> Llamar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Eliminar Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">¿Estás seguro de que deseas eliminar a <strong>{{cliente.nombre}}</strong>?</p>
        <p class="text-muted small mt-2">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Eliminar</button>
      </div>
    </div>
  </div>
</div>

{{#section 'scripts'}}
<script>
document.getElementById('confirmDelete').addEventListener('click', async function() {
  try {
    const response = await fetch('/clientes/{{cliente.id}}', {
      method: 'DELETE',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      window.location.href = '/clientes';
    } else {
      alert('Error al eliminar el cliente');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error de conexión');
  }
});
</script>

<style>
.timeline {
  position: relative;
}

.timeline-item {
  position: relative;
  padding-left: 30px;
}

.timeline-marker {
  position: absolute;
  left: 0;
  top: 5px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.timeline-content {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  padding-bottom: 15px;
}

.timeline-item:last-child .timeline-content {
  border-left: none;
}
</style>
{{/section}}
