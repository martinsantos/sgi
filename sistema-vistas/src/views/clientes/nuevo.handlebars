<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Nuevo Cliente</h4>
        </div>
        <div class="card-body">
            {{#if error}}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error:</strong> {{error}}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {{/if}}
            
            <form id="clienteForm" method="POST" action="/clientes/nuevo">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombre" name="nombre">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="codigo" class="form-label">C√≥digo</label>
                            <input type="text" class="form-control" id="codigo" name="codigo">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="tipo_cliente" class="form-label">Tipo de Cliente</label>
                            <select class="form-control" id="tipo_cliente" name="tipo_cliente">
                                <option value="">Seleccionar...</option>
                                <option value="1">Cliente</option>
                                <option value="2">Proveedor</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="tipo_persona" class="form-label">Tipo de Persona</label>
                            <select class="form-control" id="tipo_persona" name="tipo_persona">
                                <option value="">Seleccionar...</option>
                                <option value="F√≠sica">Persona F√≠sica</option>
                                <option value="Jur√≠dica">Persona Jur√≠dica</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="condicion_iva" class="form-label">Condici√≥n IVA</label>
                            <select class="form-control" id="condicion_iva" name="condicion_iva">
                                <option value="">Seleccionar...</option>
                                <option value="1">IVA Responsable Inscripto</option>
                                <option value="2">IVA Responsable No Inscripto</option>
                                <option value="3">IVA Exento</option>
                                <option value="4">No Responsable</option>
                                <option value="5">Consumidor Final</option>
                                <option value="6">Responsable Monotributo</option>
                                <option value="7">Sujeto No Categorizado</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="ejemplo@correo.com">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Tel√©fono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="+54 9 261 123-4567">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="cuil_cuit" class="form-label">CUIL/CUIT</label>
                            <input type="text" class="form-control" id="cuil_cuit" name="cuil_cuit" placeholder="20-12345678-9">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="contacto_principal" class="form-label">Contacto Principal</label>
                            <input type="text" class="form-control" id="contacto_principal" name="contacto_principal" placeholder="Nombre del contacto">
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="bi bi-save"></i> Guardar Cliente
                        </button>
                        <a href="/clientes" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Volver al Listado
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('clienteForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    console.log('üìù Formulario enviado');
    
    // Mostrar indicador de carga
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(this);
        
        // Convertir FormData a objeto JSON
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Log de datos enviados
        console.log('üì¶ Datos del formulario:');
        console.log(data);
        
        const response = await fetch('/clientes/nuevo', {
            method: 'POST',
            body: JSON.stringify(data),
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', response.headers);
        
        const contentType = response.headers.get('content-type');
        console.log('üì° Content-Type:', contentType);
        
        let result;
        if (contentType && contentType.includes('application/json')) {
            result = await response.json();
            console.log('üì¶ JSON Response:', result);
        } else {
            const text = await response.text();
            console.log('üì¶ Text Response:', text);
            result = { success: false, message: text };
        }
        
        if (response.ok && result.success) {
            console.log('‚úÖ Cliente guardado exitosamente');
            // Redirigir al listado
            window.location.href = '/clientes';
        } else {
            const errorMsg = result.message || 'No se pudo guardar el cliente';
            console.error('‚ùå Error:', errorMsg);
            alert('Error: ' + errorMsg);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        alert('Error de conexi√≥n: ' + error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});
</script>
