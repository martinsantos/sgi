{{!-- Ver Cotización Detalle --}}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="card-title mb-0">
            <i class="fas fa-dollar-sign me-2"></i>
            Cotización COT-{{cotizacion.numero}}
          </h4>
          <div class="btn-group">
            <a href="/cotizaciones" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-1"></i>
              Volver
            </a>
            {{#eq cotizacion.estado 'borrador'}}
            <button class="btn btn-outline-primary" onclick="editarCotizacion('{{cotizacion.id}}')">
              <i class="fas fa-edit me-1"></i>
              Editar
            </button>
            <button class="btn btn-success" onclick="enviarCotizacion('{{cotizacion.id}}')">
              <i class="fas fa-paper-plane me-1"></i>
              Enviar
            </button>
            {{/eq}}
            {{#eq cotizacion.estado 'recibido'}}
            <button class="btn btn-warning" onclick="compararCotizacion('{{cotizacion.id}}')">
              <i class="fas fa-balance-scale me-1"></i>
              Comparar
            </button>
            <button class="btn btn-success" onclick="seleccionarCotizacion('{{cotizacion.id}}')">
              <i class="fas fa-check me-1"></i>
              Seleccionar
            </button>
            {{/eq}}
            {{#eq cotizacion.estado 'seleccionado'}}
            <button class="btn btn-primary" onclick="generarOrdenCompra('{{cotizacion.id}}')">
              <i class="fas fa-shopping-bag me-1"></i>
              Generar O.C.
            </button>
            {{/eq}}
            <button class="btn btn-outline-info" onclick="imprimirCotizacion()">
              <i class="fas fa-print me-1"></i>
              Imprimir
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Información General -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-info-circle me-1"></i>
                  Información General
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted">N° Cotización:</small><br>
                    <strong>COT-{{cotizacion.numero}}</strong>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Estado:</small><br>
                    <span class="badge 
                      {{#eq cotizacion.estado 'borrador'}}bg-secondary{{/eq}}
                      {{#eq cotizacion.estado 'enviado'}}bg-primary{{/eq}}
                      {{#eq cotizacion.estado 'recibido'}}bg-info{{/eq}}
                      {{#eq cotizacion.estado 'comparando'}}bg-warning{{/eq}}
                      {{#eq cotizacion.estado 'seleccionado'}}bg-success{{/eq}}
                      {{#eq cotizacion.estado 'rechazado'}}bg-danger{{/eq}}
                      {{#eq cotizacion.estado 'vencido'}}bg-dark{{/eq}}
                    ">
                      {{capitalize cotizacion.estado}}
                    </span>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-6">
                    <small class="text-muted">Fecha Solicitud:</small><br>
                    <strong>{{formatDate cotizacion.fecha_solicitud}}</strong>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Válida Hasta:</small><br>
                    <strong>
                      {{#if cotizacion.fecha_vencimiento}}
                        {{formatDate cotizacion.fecha_vencimiento}}
                      {{else}}
                        Sin límite
                      {{/if}}
                    </strong>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-6">
                    <small class="text-muted">Moneda:</small><br>
                    <strong>{{cotizacion.moneda}}</strong>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Condiciones Pago:</small><br>
                    <strong>{{cotizacion.condiciones_pago}}</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-building me-1"></i>
                  Información del Proveedor
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-2">
                  <small class="text-muted">Proveedor:</small><br>
                  <strong>{{cotizacion.proveedor_nombre}}</strong>
                </div>
                {{#if cotizacion.proveedor_contacto}}
                <div class="mb-2">
                  <small class="text-muted">Contacto:</small><br>
                  <strong>{{cotizacion.proveedor_contacto}}</strong>
                </div>
                {{/if}}
                {{#if cotizacion.proveedor_email}}
                <div class="mb-2">
                  <small class="text-muted">Email:</small><br>
                  <a href="mailto:{{cotizacion.proveedor_email}}">{{cotizacion.proveedor_email}}</a>
                </div>
                {{/if}}
                {{#if cotizacion.proveedor_telefono}}
                <div class="mb-2">
                  <small class="text-muted">Teléfono:</small><br>
                  <a href="tel:{{cotizacion.proveedor_telefono}}">{{cotizacion.proveedor_telefono}}</a>
                </div>
                {{/if}}
              </div>
            </div>
          </div>
        </div>

        <!-- Información del Proyecto -->
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="card bg-light">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-project-diagram me-1"></i>
                  Proyecto y Requerimiento
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <small class="text-muted">Proyecto:</small><br>
                    <strong>{{cotizacion.proyecto_nombre}}</strong>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted">Cliente:</small><br>
                    <strong>{{cotizacion.cliente_nombre}}</strong>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted">Requerimiento:</small><br>
                    {{#if cotizacion.requerimiento_numero}}
                    <a href="/requerimientos/ver/{{cotizacion.requerimiento_id}}" class="text-decoration-none">
                      <strong>REQ-{{cotizacion.requerimiento_numero}}</strong>
                    </a>
                    {{else}}
                    <span class="text-muted">Cotización directa</span>
                    {{/if}}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Items de la Cotización -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-list me-1"></i>
              Items Cotizados ({{items.length}})
            </h6>
          </div>
          <div class="card-body">
            {{#if items}}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th width="5%">#</th>
                    <th width="30%">Material/Descripción</th>
                    <th width="10%">Cantidad</th>
                    <th width="10%">Unidad</th>
                    <th width="12%">Precio Unit.</th>
                    <th width="12%">Total</th>
                    <th width="21%">Observaciones</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each items}}
                  <tr>
                    <td>{{@index_plus_one}}</td>
                    <td>
                      <strong>{{this.nombre}}</strong>
                      {{#if this.descripcion}}
                      <br><small class="text-muted">{{this.descripcion}}</small>
                      {{/if}}
                    </td>
                    <td class="text-center">{{this.cantidad}}</td>
                    <td>{{this.unidad}}</td>
                    <td class="text-end">{{cotizacion.moneda}} {{formatNumber this.precio_unitario}}</td>
                    <td class="text-end"><strong>{{cotizacion.moneda}} {{formatNumber this.total}}</strong></td>
                    <td>
                      {{#if this.observaciones}}
                        {{this.observaciones}}
                      {{else}}
                        <span class="text-muted">--</span>
                      {{/if}}
                    </td>
                  </tr>
                  {{/each}}
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="5" class="text-end">Subtotal:</th>
                    <th class="text-end">{{cotizacion.moneda}} {{formatNumber cotizacion.monto_total}}</th>
                    <th></th>
                  </tr>
                  <tr>
                    <th colspan="5" class="text-end">IVA (21%):</th>
                    <th class="text-end">{{cotizacion.moneda}} {{formatNumber (multiply cotizacion.monto_total 0.21)}}</th>
                    <th></th>
                  </tr>
                  <tr class="table-warning">
                    <th colspan="5" class="text-end">TOTAL FINAL:</th>
                    <th class="text-end"><strong>{{cotizacion.moneda}} {{formatNumber (multiply cotizacion.monto_total 1.21)}}</strong></th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
            {{else}}
            <div class="text-center py-4">
              <i class="fas fa-list fa-2x text-muted mb-2"></i>
              <p class="text-muted">No hay items en esta cotización</p>
            </div>
            {{/if}}
          </div>
        </div>

        <!-- Observaciones -->
        {{#if cotizacion.observaciones}}
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-comment me-1"></i>
              Observaciones
            </h6>
          </div>
          <div class="card-body">
            <p class="mb-0">{{cotizacion.observaciones}}</p>
          </div>
        </div>
        {{/if}}

        <!-- Historial y Auditoría -->
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-history me-1"></i>
              Información de Registro
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <small class="text-muted">Creado:</small><br>
                <strong>{{formatDateTime cotizacion.created}}</strong>
              </div>
              <div class="col-md-6">
                <small class="text-muted">Última Modificación:</small><br>
                <strong>{{formatDateTime cotizacion.modified}}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{#section 'scripts'}}
<script>
// Enviar cotización
function enviarCotizacion(id) {
    if (confirm('¿Enviar esta cotización al proveedor?')) {
        cambiarEstadoCotizacion(id, 'enviado');
    }
}

// Comparar cotización
function compararCotizacion(id) {
    fetch(`/api/cotizaciones/${id}/comparar`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create and show comparison modal
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Comparar Cotizaciones</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${data.html}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                new bootstrap.Modal(modal).show();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(console.error);
}

// Seleccionar cotización
function seleccionarCotizacion(id) {
    if (confirm('¿Seleccionar esta cotización como ganadora?')) {
        cambiarEstadoCotizacion(id, 'seleccionado');
    }
}

// Cambiar estado de cotización
function cambiarEstadoCotizacion(id, nuevoEstado) {
    fetch(`/api/cotizaciones/${id}/estado`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al cambiar estado: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar estado');
    });
}

// Generar orden de compra
function generarOrdenCompra(id) {
    if (confirm('¿Generar orden de compra desde esta cotización?')) {
        fetch(`/api/cotizaciones/${id}/generar-orden-compra`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Orden de compra generada exitosamente');
                window.open(`/ordenes-compra/ver/${data.ordenId}`, '_blank');
            } else {
                alert('Error al generar orden de compra: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al generar orden de compra');
        });
    }
}

// Imprimir cotización
function imprimirCotizacion() {
    window.print();
}

// Editar cotización
function editarCotizacion(id) {
    window.location.href = `/cotizaciones/editar/${id}`;
}
</script>

<style>
@media print {
    .btn-group, .card-header .btn-group {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-header {
        background: white !important;
        border: none !important;
    }
}
</style>
{{/section}}
