<div class="container-fluid mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        <i class="bi bi-file-earmark-text"></i> Borradores de Facturas
      </h4>
      <a href="/facturas/nueva" class="btn btn-light">
        <i class="bi bi-plus"></i> Nueva Factura
      </a>
    </div>
    <div class="card-body">
      {{#if borradores.length}}
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="borradoresTable">
          <thead class="table-dark">
            <tr>
              <th>Tipo</th>
              <th>Punto Venta</th>
              <th>Cliente</th>
              <th>Fecha Emisión</th>
              <th>Total</th>
              <th>Fecha Creación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {{#each borradores}}
            <tr>
              <td>
                <span class="badge bg-secondary">{{this.tipo_factura}}</span>
              </td>
              <td>{{this.punto_venta}}</td>
              <td>{{this.cliente_nombre}}</td>
              <td>{{formatDate this.fecha_emision}}</td>
              <td>
                <strong class="text-muted">{{formatCurrency this.total}}</strong>
                <br><small class="text-warning">Borrador</small>
              </td>
              <td>{{formatDate this.fecha_creacion}}</td>
              <td>
                <div class="btn-group" role="group">
                  <a href="/facturas/editar/{{this.id}}" class="btn btn-sm btn-warning" title="Editar borrador">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <button class="btn btn-sm btn-success" onclick="convertirAFactura('{{this.id}}')" title="Convertir a factura">
                    <i class="bi bi-check-circle"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="eliminarBorrador('{{this.id}}')" title="Eliminar borrador">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{else}}
      <div class="text-center py-5">
        <i class="bi bi-file-earmark-text display-1 text-muted"></i>
        <h5 class="mt-3 text-muted">No hay borradores guardados</h5>
        <p class="text-muted">Los borradores de facturas aparecerán aquí cuando los guardes desde el formulario de nueva factura.</p>
        <a href="/facturas/nueva" class="btn btn-primary">
          <i class="bi bi-plus"></i> Crear Nueva Factura
        </a>
      </div>
      {{/if}}
    </div>
  </div>
</div>

{{#section 'scripts'}}
<script>
$(document).ready(function() {
  {{#if borradores.length}}
  $('#borradoresTable').DataTable({
    language: {
      processing: "Procesando...",
      search: "Buscar:",
      lengthMenu: "Mostrar _MENU_ entradas",
      info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
      infoEmpty: "Mostrando 0 a 0 de 0 entradas",
      infoFiltered: "(filtrado de _MAX_ entradas totales)",
      paginate: {
        first: "Primero",
        last: "Último",
        next: "Siguiente",
        previous: "Anterior"
      }
    },
    order: [[5, 'desc']], // Order by creation date desc
    pageLength: 25
  });
  {{/if}}
});

function convertirAFactura(borradorId) {
  if (confirm('¿Está seguro de convertir este borrador en una factura oficial? Esta acción no se puede deshacer.')) {
    fetch(`/api/facturas/borrador/${borradorId}/convertir`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Borrador convertido exitosamente a factura');
        window.location.href = `/facturas/ver/${data.factura_id}`;
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      alert('Error al convertir borrador');
      console.error(error);
    });
  }
}

function eliminarBorrador(borradorId) {
  if (confirm('¿Está seguro de eliminar este borrador? Esta acción no se puede deshacer.')) {
    fetch(`/api/facturas/borrador/${borradorId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Borrador eliminado exitosamente');
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      alert('Error al eliminar borrador');
      console.error(error);
    });
  }
}
</script>
{{/section}}
