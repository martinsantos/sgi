<div class="row">
  {{#each facturas}}
  <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
    <div class="card h-100 invoice-card {{#isOverdue fecha_vencimiento}}border-warning{{/isOverdue}} {{#eq estado 'anulada'}}border-danger{{/eq}}" 
         data-id="{{id}}">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <input type="checkbox" class="form-check-input me-2 invoice-select" value="{{id}}">
          <span class="badge bg-secondary">{{tipo_factura}}</span>
        </div>
        <span class="badge {{getStatusBadge estado}}">
          {{getStatusName estado}}
        </span>
      </div>
      
      <div class="card-body">
        <!-- Número de factura -->
        <h6 class="card-title mb-2">
          <a href="/facturas/{{id}}" class="text-decoration-none">
            {{formatNumber punto_venta 4}}-{{formatNumber numero_factura 8}}
          </a>
        </h6>

        <!-- Cliente -->
        <div class="mb-3">
          <strong class="text-primary">{{cliente.nombre}}</strong>
          {{#if cliente.cuit}}
          <br><small class="text-muted">CUIT: {{cliente.cuit}}</small>
          {{/if}}
        </div>

        <!-- Fechas importantes -->
        <div class="row text-center mb-3">
          <div class="col-6">
            <small class="text-muted d-block">Fecha</small>
            <span class="fw-bold">{{formatDate fecha_factura 'DD/MM'}}</span>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Vencimiento</small>
            <span class="fw-bold {{#isOverdue fecha_vencimiento}}text-danger{{/isOverdue}}">
              {{formatDate fecha_vencimiento 'DD/MM'}}
            </span>
          </div>
        </div>

        <!-- Monto total destacado -->
        <div class="text-center mb-3">
          <h4 class="text-primary mb-0">{{formatCurrency total}}</h4>
          {{#if subtotal}}
          <small class="text-muted">Sin IVA: {{formatCurrency subtotal}}</small>
          {{/if}}
        </div>

        <!-- Proyecto si existe -->
        {{#if proyecto}}
        <div class="mb-3">
          <div class="bg-light p-2 rounded">
            <small class="text-muted d-block">
              <i class="fas fa-project-diagram me-1"></i>Proyecto
            </small>
            <a href="/proyectos/{{proyecto.id}}" class="text-decoration-none">
              {{truncateText proyecto.nombre 30}}
            </a>
          </div>
        </div>
        {{/if}}

        <!-- Alertas importantes -->
        {{#isOverdue fecha_vencimiento}}
        <div class="alert alert-warning py-2 mb-3">
          <i class="fas fa-exclamation-triangle me-1"></i>
          <strong>Vencida</strong> ({{daysBetween fecha_vencimiento now}} días)
        </div>
        {{/isOverdue}}

        {{#eq estado 'borrador'}}
        <div class="alert alert-info py-2 mb-3">
          <i class="fas fa-info-circle me-1"></i>
          Pendiente de autorización
        </div>
        {{/eq}}
      </div>

      <div class="card-footer">
        <div class="btn-group w-100" role="group">
          <a href="/facturas/{{id}}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-eye"></i>
          </a>
          {{#ne estado 'pagada'}}
          <a href="/facturas/{{id}}/editar" class="btn btn-outline-warning btn-sm">
            <i class="fas fa-edit"></i>
          </a>
          {{/ne}}
          <a href="/facturas/{{id}}/pdf" class="btn btn-outline-danger btn-sm" target="_blank">
            <i class="fas fa-file-pdf"></i>
          </a>
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            {{#ne estado 'pagada'}}
            <li>
              <button class="dropdown-item text-success mark-paid" data-id="{{id}}">
                <i class="fas fa-check me-2"></i>Marcar como Pagada
              </button>
            </li>
            {{/ne}}
            {{#eq estado 'borrador'}}
            <li>
              <button class="dropdown-item text-primary authorize-invoice" data-id="{{id}}">
                <i class="fas fa-paper-plane me-2"></i>Autorizar
              </button>
            </li>
            {{/eq}}
            <li>
              <a class="dropdown-item" href="/facturas/{{id}}/duplicar">
                <i class="fas fa-copy me-2"></i>Duplicar
              </a>
            </li>
            {{#ne estado 'anulada'}}
            <li><hr class="dropdown-divider"></li>
            <li>
              <button class="dropdown-item text-danger cancel-invoice" data-id="{{id}}">
                <i class="fas fa-ban me-2"></i>Anular
              </button>
            </li>
            {{/ne}}
          </ul>
        </div>
      </div>
    </div>
  </div>
  {{/each}}
</div>

{{#if (gt (length facturas) 0)}}
<div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
  <div>
    <button type="button" class="btn btn-outline-primary btn-sm" id="bulkActions" style="display: none;" data-bs-toggle="modal" data-bs-target="#bulkActionsModal">
      <i class="fas fa-tasks me-1"></i>
      Acciones masivas (<span id="selectedCount">0</span>)
    </button>
  </div>
  
  <div class="text-muted">
    <small>
      Mostrando {{add pagination.offset 1}} a {{add pagination.offset (length facturas)}} de {{pagination.total}} facturas
    </small>
  </div>
</div>
{{/if}}

<style>
.invoice-card {
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
}

.invoice-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.invoice-card.border-warning {
  border-color: #ffc107 !important;
  background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
}

.invoice-card.border-danger {
  border-color: #dc3545 !important;
  background: linear-gradient(135deg, #ffe6e6 0%, #ffffff 100%);
}

.card-title a:hover {
  color: #0056b3 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Marcar como pagada
  document.addEventListener('click', function(e) {
    if (e.target.closest('.mark-paid')) {
      e.stopPropagation();
      const button = e.target.closest('.mark-paid');
      const facturaId = button.getAttribute('data-id');
      
      if (confirm('¿Confirma que desea marcar esta factura como pagada?')) {
        fetch(`/facturas/${facturaId}/marcar-pagada`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error al actualizar la factura: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al procesar la solicitud');
        });
      }
    }
  });

  // Autorizar factura
  document.addEventListener('click', function(e) {
    if (e.target.closest('.authorize-invoice')) {
      e.stopPropagation();
      const button = e.target.closest('.authorize-invoice');
      const facturaId = button.getAttribute('data-id');
      
      if (confirm('¿Confirma que desea autorizar esta factura?')) {
        fetch(`/facturas/${facturaId}/autorizar`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error al autorizar la factura: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al procesar la solicitud');
        });
      }
    }
  });

  // Anular factura
  document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-invoice')) {
      e.stopPropagation();
      const button = e.target.closest('.cancel-invoice');
      const facturaId = button.getAttribute('data-id');
      
      if (confirm('¿Está seguro que desea ANULAR esta factura? Esta acción no se puede deshacer.')) {
        const motivo = prompt('Ingrese el motivo de la anulación:');
        if (motivo) {
          fetch(`/facturas/${facturaId}/anular`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ motivo: motivo })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error al anular la factura: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
          });
        }
      }
    }
  });

  // Click en toda la tarjeta para ir al detalle
  document.addEventListener('click', function(e) {
    const card = e.target.closest('.invoice-card');
    if (card && !e.target.closest('input, button, a, .dropdown')) {
      const facturaId = card.getAttribute('data-id');
      window.location.href = `/facturas/${facturaId}`;
    }
  });
});
</script>
