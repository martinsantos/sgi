<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">ðŸ“‹ Lista de Prospectos</h1>
      <p class="text-muted mb-0">{{pagination.total}} prospectos encontrados</p>
    </div>
    <div>
      <a href="/prospectos/export/excel{{serialize filters}}" class="btn btn-success me-2" target="_blank">
        <i class="fas fa-file-excel"></i> Excel
      </a>
      <a href="/prospectos/crear" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nuevo Prospecto
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card shadow mb-4">
    <div class="card-header">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-filter"></i> Filtros de BÃºsqueda
        <button class="btn btn-sm btn-outline-primary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
          <i class="fas fa-chevron-down"></i>
        </button>
      </h6>
    </div>
    <div class="collapse show" id="filtrosCollapse">
      <div class="card-body">
        <form id="filtrosForm" method="GET">
          <div class="row">
            <!-- BÃºsqueda por texto -->
            <div class="col-md-3">
              <div class="mb-3">
                <label for="search" class="form-label">Buscar</label>
                <input type="text" class="form-control" id="search" name="search" value="{{filters.search}}" placeholder="Nombre, empresa, email...">
              </div>
            </div>

            <!-- Filtro por estado -->
            <div class="col-md-2">
              <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select class="form-control" id="estado" name="estado">
                  <option value="">Todos los estados</option>
                  {{#each estados}}
                    <option value="{{value}}" {{selectedIf (eq ../filters.estado value)}}>{{label}}</option>
                  {{/each}}
                </select>
              </div>
            </div>

            <!-- Filtro por origen -->
            <div class="col-md-2">
              <div class="mb-3">
                <label for="origen" class="form-label">Origen</label>
                <input type="text" class="form-control" id="origen" name="origen" value="{{filters.origen}}" placeholder="Web, Referido...">
              </div>
            </div>

            <!-- Fecha desde -->
            <div class="col-md-2">
              <div class="mb-3">
                <label for="fecha_desde" class="form-label">Desde</label>
                <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="{{filters.fecha_desde}}">
              </div>
            </div>

            <!-- Fecha hasta -->
            <div class="col-md-2">
              <div class="mb-3">
                <label for="fecha_hasta" class="form-label">Hasta</label>
                <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="{{filters.fecha_hasta}}">
              </div>
            </div>

            <!-- Botones -->
            <div class="col-md-1">
              <div class="mb-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tabla de prospectos -->
  <div class="card shadow">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        Prospectos
        {{#if filters.search}}
          <small class="text-muted">- Filtrado por: "{{filters.search}}"</small>
        {{/if}}
      </h6>
    </div>
    <div class="card-body">
      {{#if prospectos}}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>
                  <a href="?sortBy=nombre&sortOrder={{#ifEquals sortBy 'nombre'}}{{#ifEquals sortOrder 'ASC'}}DESC{{else}}ASC{{/ifEquals}}{{else}}ASC{{/ifEquals}}{{serialize filters 'sortBy,sortOrder'}}" class="text-decoration-none">
                    Prospecto
                    {{#ifEquals sortBy 'nombre'}}
                      <i class="fas fa-sort-{{#ifEquals sortOrder 'ASC'}}up{{else}}down{{/ifEquals}}"></i>
                    {{else}}
                      <i class="fas fa-sort text-muted"></i>
                    {{/ifEquals}}
                  </a>
                </th>
                <th>Empresa</th>
                <th>Contacto</th>
                <th>
                  <a href="?sortBy=estado&sortOrder={{#ifEquals sortBy 'estado'}}{{#ifEquals sortOrder 'ASC'}}DESC{{else}}ASC{{/ifEquals}}{{else}}ASC{{/ifEquals}}{{serialize filters 'sortBy,sortOrder'}}" class="text-decoration-none">
                    Estado
                    {{#ifEquals sortBy 'estado'}}
                      <i class="fas fa-sort-{{#ifEquals sortOrder 'ASC'}}up{{else}}down{{/ifEquals}}"></i>
                    {{else}}
                      <i class="fas fa-sort text-muted"></i>
                    {{/ifEquals}}
                  </a>
                </th>
                <th>Origen</th>
                <th>
                  <a href="?sortBy=valor_estimado&sortOrder={{#ifEquals sortBy 'valor_estimado'}}{{#ifEquals sortOrder 'ASC'}}DESC{{else}}ASC{{/ifEquals}}{{else}}DESC{{/ifEquals}}{{serialize filters 'sortBy,sortOrder'}}" class="text-decoration-none">
                    Valor Est.
                    {{#ifEquals sortBy 'valor_estimado'}}
                      <i class="fas fa-sort-{{#ifEquals sortOrder 'ASC'}}up{{else}}down{{/ifEquals}}"></i>
                    {{else}}
                      <i class="fas fa-sort text-muted"></i>
                    {{/ifEquals}}
                  </a>
                </th>
                <th>
                  <a href="?sortBy=fecha_contacto&sortOrder={{#ifEquals sortBy 'fecha_contacto'}}{{#ifEquals sortOrder 'ASC'}}DESC{{else}}ASC{{/ifEquals}}{{else}}DESC{{/ifEquals}}{{serialize filters 'sortBy,sortOrder'}}" class="text-decoration-none">
                    Contacto
                    {{#ifEquals sortBy 'fecha_contacto'}}
                      <i class="fas fa-sort-{{#ifEquals sortOrder 'ASC'}}up{{else}}down{{/ifEquals}}"></i>
                    {{else}}
                      <i class="fas fa-sort text-muted"></i>
                    {{/ifEquals}}
                  </a>
                </th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each prospectos}}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px; font-size: 12px;">
                        {{substring nombre_completo 0 2}}
                      </div>
                      <div>
                        <div class="fw-bold">
                          <a href="/prospectos/ver/{{id}}" class="text-decoration-none">{{nombre_completo}}</a>
                        </div>
                        {{#if convertido_cliente_id}}
                          <small class="text-success">
                            <i class="fas fa-check"></i> Convertido a cliente
                          </small>
                        {{/if}}
                      </div>
                    </div>
                  </td>
                  <td>
                    {{#if empresa}}
                      {{empresa}}
                    {{else}}
                      <span class="text-muted">Sin empresa</span>
                    {{/if}}
                  </td>
                  <td>
                    <div>
                      {{#if email}}<div><i class="fas fa-envelope text-muted me-1"></i> {{email}}</div>{{/if}}
                      {{#if telefono}}<div><i class="fas fa-phone text-muted me-1"></i> {{telefono}}</div>{{/if}}
                    </div>
                  </td>
                  <td>
                    {{#if (eq estado 0)}}
                      <span class="badge bg-secondary">Nuevo</span>
                    {{else if (eq estado 1)}}
                      <span class="badge bg-info">Contactado</span>
                    {{else if (eq estado 2)}}
                      <span class="badge bg-warning">Calificado</span>
                    {{else if (eq estado 3)}}
                      <span class="badge bg-primary">Propuesta</span>
                    {{else if (eq estado 4)}}
                      <span class="badge bg-danger">No Interesado</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if origen}}
                      <span class="badge bg-light text-dark">{{origen}}</span>
                    {{else}}
                      <span class="text-muted">-</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if valor_estimado}}
                      <span class="fw-bold text-success">${{formatCurrency valor_estimado}}</span>
                      {{#if probabilidad}}
                        <div class="text-muted small">{{probabilidad}}% prob.</div>
                      {{/if}}
                    {{else}}
                      <span class="text-muted">No estimado</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if fecha_contacto}}
                      {{formatDate fecha_contacto}}
                    {{else}}
                      <span class="text-muted">Sin contacto</span>
                    {{/if}}
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <a href="/prospectos/ver/{{id}}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="/prospectos/{{id}}/editar" class="btn btn-sm btn-outline-warning" title="Editar">
                        <i class="fas fa-edit"></i>
                      </a>
                      {{#unless convertido_cliente_id}}
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="convertirACliente('{{id}}')" title="Convertir a cliente">
                          <i class="fas fa-user-plus"></i>
                        </button>
                      {{/unless}}
                      <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarProspecto('{{id}}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>

        <!-- PaginaciÃ³n -->
        {{#if (gt pagination.pages 1)}}
          <nav aria-label="PaginaciÃ³n de prospectos">
            <ul class="pagination justify-content-center">
              {{#if (gt pagination.page 1)}}
                <li class="page-item">
                  <a class="page-link" href="?page=1{{serialize filters 'page'}}" aria-label="Primera">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{subtract pagination.page 1}}{{serialize filters 'page'}}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
              {{/if}}

              {{#each (range (subtract pagination.page 2) (add pagination.page 2))}}
                {{#if (and (gte this 1) (lte this ../pagination.pages))}}
                  <li class="page-item {{#if (eq this ../pagination.page)}}active{{/if}}">
                    <a class="page-link" href="?page={{this}}{{serialize ../filters 'page'}}">{{this}}</a>
                  </li>
                {{/if}}
              {{/each}}

              {{#if (lt pagination.page pagination.pages)}}
                <li class="page-item">
                  <a class="page-link" href="?page={{add pagination.page 1}}{{serialize filters 'page'}}" aria-label="Siguiente">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{pagination.pages}}{{serialize filters 'page'}}" aria-label="Ãšltima">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                  </a>
                </li>
              {{/if}}
            </ul>
          </nav>
        {{/if}}

        <!-- Info de paginaciÃ³n -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted">
            Mostrando {{multiply (subtract pagination.page 1) pagination.limit}} - {{#if (lt (multiply pagination.page pagination.limit) pagination.total)}}{{multiply pagination.page pagination.limit}}{{else}}{{pagination.total}}{{/if}} de {{pagination.total}} prospectos
          </div>
          <div>
            <select class="form-select form-select-sm" onchange="changePageSize(this.value)">
              <option value="20" {{selectedIf (eq pagination.limit 20)}}>20 por pÃ¡gina</option>
              <option value="50" {{selectedIf (eq pagination.limit 50)}}>50 por pÃ¡gina</option>
              <option value="100" {{selectedIf (eq pagination.limit 100)}}>100 por pÃ¡gina</option>
            </select>
          </div>
        </div>
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
          <h5 class="text-muted">No se encontraron prospectos</h5>
          <p class="text-muted mb-4">
            {{#if filters.search}}
              No hay prospectos que coincidan con tu bÃºsqueda.
            {{else}}
              AÃºn no hay prospectos registrados en el sistema.
            {{/if}}
          </p>
          <a href="/prospectos/crear" class="btn btn-primary">
            <i class="fas fa-plus"></i> Crear Primer Prospecto
          </a>
        </div>
      {{/if}}
    </div>
  </div>
</div>

<!-- Modal para conversiÃ³n a cliente -->
<div class="modal fade" id="convertirClienteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Convertir a Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formConvertirCliente">
          <input type="hidden" id="prospectoIdConvertir" name="prospectoId">
          <div class="mb-3">
            <label for="codigoCliente" class="form-label">CÃ³digo de Cliente</label>
            <input type="text" class="form-control" id="codigoCliente" name="codigo" placeholder="Se generarÃ¡ automÃ¡ticamente si se deja vacÃ­o">
          </div>
          <div class="mb-3">
            <label for="tipoPersona" class="form-label">Tipo de Persona</label>
            <select class="form-control" id="tipoPersona" name="tipo_persona">
              <option value="fisica">FÃ­sica</option>
              <option value="juridica">JurÃ­dica</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="condicionIva" class="form-label">CondiciÃ³n IVA</label>
            <select class="form-control" id="condicionIva" name="condicion_iva">
              <option value="1">IVA Responsable Inscripto</option>
              <option value="5" selected>Consumidor Final</option>
              <option value="6">Responsable Monotributo</option>
              <option value="3">IVA Exento</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="confirmarConversion()">
          <i class="fas fa-user-plus"></i> Convertir a Cliente
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Sistema SGI</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body" id="toast-message"></div>
  </div>
</div>

<script>
$(document).ready(function() {
  console.log('Lista de prospectos cargada');
});

function changePageSize(newLimit) {
  const url = new URL(window.location);
  url.searchParams.set('limit', newLimit);
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}

function convertirACliente(prospectoId) {
  $('#prospectoIdConvertir').val(prospectoId);
  $('#convertirClienteModal').modal('show');
}

function confirmarConversion() {
  const prospectoId = $('#prospectoIdConvertir').val();
  const formData = new FormData(document.getElementById('formConvertirCliente'));
  const data = {};
  
  for (let [key, value] of formData.entries()) {
    if (key !== 'prospectoId') {
      data[key] = value;
    }
  }
  
  $.ajax({
    url: `/prospectos/api/${prospectoId}/convertir`,
    method: 'POST',
    data: data,
    success: function(response) {
      if (response.success) {
        showToast('Prospecto convertido a cliente exitosamente', 'success');
        $('#convertirClienteModal').modal('hide');
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(response.message || 'Error al convertir prospecto', 'error');
      }
    },
    error: function(xhr) {
      const response = xhr.responseJSON;
      showToast(response?.message || 'Error al convertir prospecto', 'error');
    }
  });
}

function eliminarProspecto(prospectoId) {
  if (!confirm('Â¿EstÃ¡ seguro de eliminar este prospecto?')) return;
  
  $.ajax({
    url: `/prospectos/${prospectoId}`,
    method: 'DELETE',
    success: function(response) {
      if (response.success) {
        showToast('Prospecto eliminado exitosamente', 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(response.message || 'Error al eliminar prospecto', 'error');
      }
    },
    error: function(xhr) {
      const response = xhr.responseJSON;
      showToast(response?.message || 'Error al eliminar prospecto', 'error');
    }
  });
}

function showToast(message, type = 'info') {
  const $toast = $('#toast');
  const $toastBody = $('#toast-message');
  
  $toastBody.text(message);
  
  $toast.removeClass('bg-success bg-danger bg-warning bg-info');
  if (type === 'success') {
    $toast.addClass('bg-success text-white');
  } else if (type === 'error') {
    $toast.addClass('bg-danger text-white');
  } else if (type === 'warning') {
    $toast.addClass('bg-warning');
  } else {
    $toast.addClass('bg-info');
  }
  
  const toast = new bootstrap.Toast($toast[0]);
  toast.show();
}
</script>
