name: CD - Deploy a Producciรณn

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Saltar tests (NO RECOMENDADO)'
        required: false
        default: 'false'

jobs:
  pre-deploy-validation:
    name: Validaciรณn Pre-Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout cรณdigo
        uses: actions/checkout@v4
      
      - name: ๐ข Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ๐ฆ Instalar dependencias
        run: npm ci
      
      - name: ๐งช Ejecutar tests completos
        if: github.event.inputs.skip_tests != 'true'
        run: npm test -- --coverage
        env:
          NODE_ENV: test
      
      - name: โ๏ธ ADVERTENCIA - Tests saltados
        if: github.event.inputs.skip_tests == 'true'
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ๏ธ  ADVERTENCIA: TESTS SALTADOS"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Se estรก desplegando SIN ejecutar tests."
          echo "Esto NO es recomendado en producciรณn."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      
      - name: ๐ Crear reporte de deploy
        run: |
          echo "Deploy trigger: ${{ github.event_name }}" > deploy-info.txt
          echo "Branch: ${{ github.ref_name }}" >> deploy-info.txt
          echo "Commit: ${{ github.sha }}" >> deploy-info.txt
          echo "Autor: ${{ github.actor }}" >> deploy-info.txt
          echo "Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> deploy-info.txt
          cat deploy-info.txt
      
      - name: ๐ค Upload deploy info
        uses: actions/upload-artifact@v3
        with:
          name: deploy-info
          path: deploy-info.txt

  deploy-to-production:
    name: Deploy SGI a Producciรณn
    runs-on: ubuntu-latest
    needs: pre-deploy-validation
    environment:
      name: production
      url: https://sgi.ultimamilla.com.ar
    
    steps:
      - name: ๐ฅ Checkout cรณdigo
        uses: actions/checkout@v4
      
      - name: ๐ Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 23.105.176.45 >> ~/.ssh/known_hosts
      
      - name: ๐ Deploy a servidor de producciรณn
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ INICIANDO DEPLOY A PRODUCCIรN"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Servidor: 23.105.176.45"
          echo "Aplicaciรณn: SGI (Puerto 3456)"
          echo "Mรฉtodo: PM2 restart"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          
          # Crear backup antes de deploy
          ssh root@23.105.176.45 << 'ENDSSH'
            echo "๐ฆ Creando backup pre-deploy..."
            cd /home/sgi.ultimamilla.com.ar
            BACKUP_DIR="/home/backups/sgi/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # Backup de archivos crรญticos
            cp -r src "$BACKUP_DIR/" 2>/dev/null || true
            cp -r tests "$BACKUP_DIR/" 2>/dev/null || true
            cp package*.json "$BACKUP_DIR/" 2>/dev/null || true
            
            echo "โ Backup creado en: $BACKUP_DIR"
          ENDSSH
          
          # Sincronizar archivos
          echo "๐ค Sincronizando archivos..."
          rsync -avz --exclude 'node_modules' \
                     --exclude '.git' \
                     --exclude '.env' \
                     --exclude 'coverage' \
                     --exclude '.DS_Store' \
                     ./ root@23.105.176.45:/home/sgi.ultimamilla.com.ar/
          
          # Ejecutar comandos en servidor
          ssh root@23.105.176.45 << 'ENDSSH'
            cd /home/sgi.ultimamilla.com.ar
            
            echo "๐ฆ Instalando/actualizando dependencias..."
            npm install --production
            
            echo "๐ Reiniciando aplicaciรณn SGI con PM2..."
            pm2 restart sgi
            
            echo "โณ Esperando 5 segundos para estabilizaciรณn..."
            sleep 5
            
            echo "๐ Verificando estado del servicio..."
            pm2 status sgi
            
            # Verificar que la app responde
            echo "๐ Verificando endpoint..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3456/ || echo "000")
            
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ] || [ "$STATUS" = "401" ]; then
              echo "โ Aplicaciรณn respondiendo correctamente (HTTP $STATUS)"
            else
              echo "โ๏ธ  Aplicaciรณn retorna HTTP $STATUS"
            fi
            
            echo "๐ Logs recientes:"
            pm2 logs sgi --lines 20 --nostream
          ENDSSH
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ DEPLOY COMPLETADO"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      
      - name: ๐ Verificaciรณn post-deploy
        run: |
          echo "Verificando aplicaciรณn en producciรณn..."
          sleep 10
          
          # Verificar desde internet
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sgi.ultimamilla.com.ar/ || echo "000")
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ] || [ "$STATUS" = "401" ]; then
            echo "โ SGI accesible desde internet (HTTP $STATUS)"
          else
            echo "โ๏ธ  Posible problema - HTTP $STATUS"
            echo "Verificar manualmente: https://sgi.ultimamilla.com.ar"
          fi
      
      - name: ๐ข Notificaciรณn de deploy exitoso
        if: success()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ DEPLOY EXITOSO"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "URL: https://sgi.ultimamilla.com.ar"
          echo "Servidor: 23.105.176.45"
          echo "Puerto: 3456"
          echo "Proceso: PM2 (sgi)"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      
      - name: ๐จ Rollback automรกtico en caso de fallo
        if: failure()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐จ DEPLOY FALLร - INICIANDO ROLLBACK"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          
          ssh root@23.105.176.45 << 'ENDSSH'
            cd /home/sgi.ultimamilla.com.ar
            
            # Encontrar รบltimo backup
            LAST_BACKUP=$(ls -td /home/backups/sgi/* | head -1)
            
            if [ -n "$LAST_BACKUP" ] && [ -d "$LAST_BACKUP" ]; then
              echo "๐ฆ Restaurando desde: $LAST_BACKUP"
              
              # Restaurar archivos
              cp -rf "$LAST_BACKUP"/* ./
              
              # Reinstalar dependencias del backup
              npm install --production
              
              # Reiniciar servicio
              pm2 restart sgi
              
              echo "โ Rollback completado"
              pm2 status sgi
            else
              echo "โ๏ธ  No se encontrรณ backup para rollback"
              echo "Verificar manualmente el estado del servicio"
            fi
          ENDSSH
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          exit 1

  post-deploy-tests:
    name: Tests Post-Deploy
    runs-on: ubuntu-latest
    needs: deploy-to-production
    
    steps:
      - name: ๐ Verificar endpoints pรบblicos
        run: |
          echo "Verificando endpoints de SGI..."
          
          # Verificar que el sistema responde
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sgi.ultimamilla.com.ar/ || echo "000")
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ] || [ "$STATUS" = "401" ]; then
            echo "โ SGI accesible (HTTP $STATUS)"
          else
            echo "โ SGI no accesible (HTTP $STATUS)"
            exit 1
          fi
      
      - name: ๐ Generar reporte de deploy
        if: always()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ REPORTE DE DEPLOY"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"
          echo "Rama: ${{ github.ref_name }}"
          echo "Autor: ${{ github.actor }}"
          echo "Estado: ${{ job.status }}"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
