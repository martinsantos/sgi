name: Tests Nocturnos Completos

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 2 AM UTC (11 PM Argentina)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  comprehensive-tests:
    name: Suite Completa de Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci
      
      - name: ğŸ§ª Tests completos con coverage
        run: npm test -- --coverage --verbose
        env:
          NODE_ENV: test
      
      - name: ğŸ“Š Reporte detallado de coverage
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š REPORTE DE COVERAGE NOCTURNO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          npm test -- --coverage --coverageReporters=text
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ğŸ“ˆ Guardar reporte de coverage
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report-${{ github.run_number }}
          path: coverage/
      
      - name: ğŸ” AnÃ¡lisis de cÃ³digo estÃ¡tico
        run: |
          echo "Analizando calidad de cÃ³digo..."
          npm run lint --if-present || echo "Lint no configurado"
        continue-on-error: true
      
      - name: ğŸ“Š EstadÃ­sticas de tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ESTADÃSTICAS DE TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"
          
          # Contar archivos de tests
          echo "Archivos de test: $(find tests -name '*.test.js' -o -name '*.spec.js' | wc -l)"
          
          # Total de lÃ­neas de tests
          echo "LÃ­neas de cÃ³digo de tests: $(find tests -name '*.test.js' -o -name '*.spec.js' -exec wc -l {} + | tail -1)"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  health-check-production:
    name: Health Check de ProducciÃ³n
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸŒ Verificar SGI en producciÃ³n
        run: |
          echo "Verificando estado de SGI..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sgi.ultimamilla.com.ar/ || echo "000")
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ] || [ "$STATUS" = "401" ]; then
            echo "âœ… SGI funcionando correctamente (HTTP $STATUS)"
          else
            echo "âŒ SGI con problemas (HTTP $STATUS)"
            exit 1
          fi
      
      - name: ğŸ“Š Reporte de health check
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ HEALTH CHECK NOCTURNO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "URL: https://sgi.ultimamilla.com.ar"
          echo "Estado: ${{ job.status }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
